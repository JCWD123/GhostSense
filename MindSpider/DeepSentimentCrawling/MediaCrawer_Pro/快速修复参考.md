# ğŸ”§ MediaCrawer Pro - å¿«é€Ÿä¿®å¤å‚è€ƒ

> æ‰€æœ‰ bug ä¿®å¤çš„å¿«é€Ÿå‚è€ƒå¡ç‰‡

---

## âœ… ä¿®å¤ 1: note_id ä¸ºç©º

**é—®é¢˜ï¼š** `âš ï¸ search result note_card æœªåŒ…å« note_idï¼Œä½¿ç”¨ç©ºå­—ç¬¦ä¸²ä¿å­˜`

**åŸå› ï¼š** `id` åœ¨ `item` å±‚çº§ï¼Œä¸åœ¨ `note_card` å±‚çº§

**ä¿®å¤ï¼š** `backend/crawler/xhs_client.py:187-194`

```python
for item in items:
    note_card = item.get("note_card", {})
    if "id" in item:
        note_card["note_id"] = item["id"]  # âœ… æ³¨å…¥ id
    notes.append(self._parse_note_card(note_card))
```

**æµ‹è¯•ï¼š** `python backend/test_new_crawl.py`

---

## âœ… ä¿®å¤ 2: xsec_token ç¼ºå¤±

**é—®é¢˜ï¼š** `âš ï¸ ç¬”è®° xxx ç¼ºå°‘ xsec_tokenï¼Œè·³è¿‡è¯„è®ºæŠ“å–`

**åŸå› ï¼š** æœç´¢æ¥å£ä¸è¿”å› xsec_token

**ä¿®å¤ï¼š** è‡ªåŠ¨è¯·æ±‚è¯¦æƒ…é¡µè·å– token

**æ¥å£ï¼š** âœ… `POST /api/sns/web/v1/note/detail`

```python
# backend/crawler/xhs_client.py:244-350
async def get_note_detail_for_token(self, note_id: str):
    data = {"note_id": note_id, "image_formats": ["jpg", "webp", "avif"]}
    result = await self.post(f"{self.base_url}/api/sns/web/v1/note/detail", json=data)
    return result["data"]["xsec_token"]
```

**æµ‹è¯•ï¼š** `python backend/test_xsec_token_fix.py`

---

## âš ï¸ æ¥å£ä¿®æ­£ï¼ˆé‡è¦ï¼‰

### âŒ é”™è¯¯æ¥å£ï¼ˆä¼š 404ï¼‰

```
GET /api/sns/web/v1/feed?source_note_id=xxx
```

è¿™æ˜¯**æ¨èå†…å®¹æµæ¥å£**ï¼Œä¸æ˜¯è¯¦æƒ…æ¥å£ï¼

### âœ… æ­£ç¡®æ¥å£

```
POST /api/sns/web/v1/note/detail
Body: {"note_id": "xxx", "image_formats": ["jpg", "webp", "avif"]}
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

| åŠŸèƒ½ | ä¿®å¤å‰ | ä¿®å¤å |
|-----|--------|--------|
| **note_id** | âŒ ç©ºå­—ç¬¦ä¸² | âœ… æœ‰æ•ˆ ID |
| **xsec_token** | âŒ æ—  | âœ… è‡ªåŠ¨è·å– |
| **è¯„è®ºæŠ“å–** | âŒ 0 æ¡ | âœ… æ­£å¸¸æŠ“å– |
| **æ•°æ®è´¨é‡** | âŒ ä¸å¯ç”¨ | âœ… ç”Ÿäº§å¯ç”¨ |

---

## ğŸš€ å¿«é€ŸéªŒè¯

```bash
# 1. æ£€æŸ¥æ•°æ®åº“
python backend/check_database.py

# é¢„æœŸï¼š
# æœ‰æ•ˆ note_id: >0
# ç©º note_id: 0
# comments: >0 æ¡

# 2. æµ‹è¯• note_id ä¿®å¤
python backend/test_new_crawl.py

# é¢„æœŸï¼š
# âœ… æœ‰æ•ˆ note_id: 5/5

# 3. æµ‹è¯• xsec_token ä¿®å¤
python backend/test_xsec_token_fix.py

# é¢„æœŸï¼š
# âœ… æˆåŠŸè·å– xsec_token: 3/3
# âœ… æˆåŠŸè·å– 15 æ¡è¯„è®º
```

---

## ğŸ“š å®Œæ•´æ–‡æ¡£

| æ–‡æ¡£ | è¯´æ˜ |
|-----|------|
| [note_idé—®é¢˜è¯Šæ–­å’Œä¿®å¤æŒ‡å—](docs/note_idé—®é¢˜è¯Šæ–­å’Œä¿®å¤æŒ‡å—.md) | note_id è¯¦ç»†åˆ†æ |
| [xsec_tokenè·å–ä¿®å¤æŒ‡å—](docs/xsec_tokenè·å–ä¿®å¤æŒ‡å—.md) | xsec_token å®Œæ•´æ–¹æ¡ˆ |
| [APIæ¥å£ä¿®æ­£è¯´æ˜](docs/APIæ¥å£ä¿®æ­£è¯´æ˜.md) | æ¥å£é”™è¯¯ä¿®æ­£ |
| [Dockeréƒ¨ç½²æŒ‡å—](docs/Dockeréƒ¨ç½²æŒ‡å—.md) | Docker éƒ¨ç½² |

---

## ğŸ› ï¸ å·¥å…·è„šæœ¬

```bash
python backend/check_database.py          # æ•°æ®åº“è¯Šæ–­
python backend/test_new_crawl.py          # æµ‹è¯• note_id
python backend/test_xsec_token_fix.py     # æµ‹è¯• xsec_token
python backend/fix_empty_note_ids.py      # ä¿®å¤æ—§æ•°æ®
```

---

## ğŸ¯ å°çº¢ä¹¦ API é€ŸæŸ¥

| æ¥å£ | æ–¹æ³• | ç”¨é€” | è¿”å› xsec_token |
|-----|------|------|----------------|
| `/api/sns/web/v1/search/notes` | POST | æœç´¢ç¬”è®° | âŒ |
| `/api/sns/web/v1/note/detail` | POST | ç¬”è®°è¯¦æƒ… | âœ… |
| `/api/sns/web/v2/comment/page` | GET | è¯„è®ºåˆ—è¡¨ | âŒ |

---

**æ‰€æœ‰ä¿®å¤å·²å®Œæˆï¼** ğŸ‰


