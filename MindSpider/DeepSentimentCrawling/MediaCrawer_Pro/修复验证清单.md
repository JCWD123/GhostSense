# âœ… MediaCrawler Pro ç­¾åé—®é¢˜ä¿®å¤éªŒè¯æ¸…å•

## ğŸ¯ å·²å®Œæˆçš„ä¿®å¤

### 1. Signature-Service ä¿®å¤

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| ç§»é™¤ä¸å­˜åœ¨çš„æ¨¡å—å¼•ç”¨ | âœ… | åˆ é™¤äº† `require('../utils/xhs_sign_enhanced')` |
| Playwrightæ•è·x-b3-traceid | âœ… | `xhs_browser.js` å·²æ·»åŠ æ•è· |
| æµè§ˆå™¨æ¨¡å¼APIç«¯ç‚¹ | âœ… | `/sign/xhs/browser` æ­£å¸¸å·¥ä½œ |
| ä½è¿ç®—ä¿®å¤ | âœ… | ä½¿ç”¨BigInté¿å…ç²¾åº¦é—®é¢˜ |

**éªŒè¯æ–¹æ³•ï¼š**
```bash
cd signature-service
npm start
# åº”è¯¥æ­£å¸¸å¯åŠ¨ï¼Œæ— æŠ¥é”™
```

---

### 2. Backend ä¿®å¤

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| XHSClientä½¿ç”¨æµè§ˆå™¨æ¨¡å¼ | âœ… | é»˜è®¤è°ƒç”¨ `/sign/xhs/browser` |
| è‡ªåŠ¨é™çº§æœºåˆ¶ | âœ… | æµè§ˆå™¨å¤±è´¥è‡ªåŠ¨åˆ‡æ¢åˆ°çº¯JS |
| å®Œæ•´è¯·æ±‚å¤´æ”¯æŒ | âœ… | åŒ…æ‹¬ x-s-common, x-b3-traceid |
| HybridSignatureClient | âœ… | æ”¯æŒä¸‰ç§æ¨¡å¼ï¼ˆjs/browser/autoï¼‰ |

**éªŒè¯æ–¹æ³•ï¼š**
æŸ¥çœ‹æ—¥å¿—åº”åŒ…å«ï¼š
```
ğŸŒ ä½¿ç”¨æµè§ˆå™¨æ¨¡å¼è·å–å®Œæ•´ç­¾åï¼ˆåŒ…æ‹¬ x-s-commonï¼‰
âœ… æµè§ˆå™¨æ¨¡å¼è·å–ç­¾åæˆåŠŸ:
   x-s: ...
   x-t: ...
   x-s-common: ...  â† å…³é”®ï¼
   x-b3-traceid: ... â† å…³é”®ï¼
```

---

### 3. Playwright ä¸ Electron é›†æˆ

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| Electronè°ƒè¯•ç«¯å£ | âœ… | ç«¯å£9222å·²é…ç½® |
| Playwright CDPè¿æ¥ | âœ… | å¯è¿æ¥åˆ°Electron |
| è¯·æ±‚å¤´æ‹¦æˆª | âœ… | è‡ªåŠ¨æ•è·å®Œæ•´è¯·æ±‚å¤´ |

**éªŒè¯æ–¹æ³•ï¼š**
```bash
# 1. å¯åŠ¨Electron
cd frontend
npm run electron:dev

# 2. éªŒè¯è°ƒè¯•ç«¯å£
curl http://localhost:9222/json/version
# åº”è¯¥è¿”å›JSONï¼ŒåŒ…å«æµè§ˆå™¨ç‰ˆæœ¬ä¿¡æ¯
```

---

## âŒ å°šæœªå®ç°çš„åŠŸèƒ½

### 1. çº¯JSç”Ÿæˆ x-s-common

| çŠ¶æ€ | è¯´æ˜ |
|------|------|
| âŒ æœªå®ç° | x-s-commonçš„çº¯JSé€†å‘éå¸¸å¤æ‚ |
| ğŸ’¡ æ›¿ä»£æ–¹æ¡ˆ | ä½¿ç”¨æµè§ˆå™¨æ¨¡å¼ï¼ˆå·²å®ç°ä¸”ç¨³å®šï¼‰ |

### 2. xsec_token è‡ªåŠ¨æå–

| çŠ¶æ€ | è¯´æ˜ |
|------|------|
| âŒ æœªå®ç° | è¯„è®ºæ¥å£éœ€è¦ä»ç¬”è®°è¯¦æƒ…ä¸­æå– |
| ğŸ’¡ è§£å†³æ–¹æ¡ˆ | è§ä¸‹æ–¹ä»£ç ç¤ºä¾‹ |

**ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼š**

```python
# åœ¨è°ƒç”¨è¯„è®ºæ¥å£å‰ï¼Œå…ˆè·å–ç¬”è®°è¯¦æƒ…
async def get_comments_with_token(note_id: str):
    # 1. è·å–ç¬”è®°è¯¦æƒ…ï¼ˆåŒ…å«xsec_tokenï¼‰
    detail_response = await client.get_note_detail(note_id)
    xsec_token = detail_response.get("xsec_token", "")
    
    # 2. ä½¿ç”¨xsec_tokenè°ƒç”¨è¯„è®ºæ¥å£
    comments = await client.get_note_comments(
        note_id=note_id,
        xsec_token=xsec_token,
        xsec_source="pc_search"
    )
    return comments
```

---

## ğŸ” å®Œæ•´æµ‹è¯•æµç¨‹

### æ­¥éª¤1ï¼šå¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
# ç»ˆç«¯1ï¼šç­¾åæœåŠ¡
cd signature-service
npm start
# ç­‰å¾…çœ‹åˆ°ï¼šğŸ“¦ MediaCrawler ç­¾åæœåŠ¡å·²å¯åŠ¨

# ç»ˆç«¯2ï¼šElectronå‰ç«¯
cd frontend
npm run electron:dev
# ç­‰å¾…çœ‹åˆ°ï¼šğŸ” è¿œç¨‹è°ƒè¯•å·²å¯ç”¨ï¼Œç«¯å£: 9222

# ç»ˆç«¯3ï¼šPythonåç«¯
cd backend
python main.py
# ç­‰å¾…çœ‹åˆ°ï¼šApplication startup complete
```

### æ­¥éª¤2ï¼šéªŒè¯ç­¾åæœåŠ¡

```bash
# æµ‹è¯•çº¯JSç­¾å
curl -X POST http://localhost:3100/sign/xhs \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://edith.xiaohongshu.com/api/sns/web/v1/search/notes",
    "method": "POST",
    "data": {"keyword": "ç¾é£Ÿ"},
    "a1": "test_a1"
  }'

# åº”è¯¥è¿”å›ï¼š
# {"success": true, "data": {"x-s": "...", "x-t": "..."}}
```

### æ­¥éª¤3ï¼šéªŒè¯æµè§ˆå™¨æ¨¡å¼

```bash
# æµ‹è¯•æµè§ˆå™¨æ¨¡å¼ï¼ˆéœ€è¦Electronè¿è¡Œï¼‰
curl -X POST http://localhost:3100/sign/xhs/browser \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://edith.xiaohongshu.com/api/sns/web/v1/search/notes",
    "method": "POST",
    "data": {"keyword": "ç¾é£Ÿ"},
    "cookie": "a1=xxx; webId=xxx",
    "debugPort": 9222
  }'

# åº”è¯¥è¿”å›ï¼ˆåŒ…æ‹¬x-s-commonï¼‰ï¼š
# {
#   "success": true,
#   "data": {
#     "x-s": "...",
#     "x-t": "...",
#     "x-s-common": "...",  â† å…³é”®ï¼
#     "x-b3-traceid": "..."
#   }
# }
```

### æ­¥éª¤4ï¼šéªŒè¯Pythonåç«¯

åˆ›å»ºæµ‹è¯•æ–‡ä»¶ `test_signature.py`ï¼š

```python
#!/usr/bin/env python3
import asyncio
from crawler.xhs_client import XHSClient

async def test():
    async with XHSClient() as client:
        # è®¾ç½®Cookieï¼ˆä»æµè§ˆå™¨è·å–ï¼‰
        client.set_cookie("a1=xxx; webId=xxx; web_session=xxx")
        
        # æµ‹è¯•æœç´¢
        result = await client.search_notes("ç¾é£Ÿ", page=1, page_size=5)
        
        if result:
            print("âœ… æµ‹è¯•æˆåŠŸï¼")
            print(f"æ‰¾åˆ° {len(result)} æ¡ç¬”è®°")
            for note in result[:3]:
                print(f"  - {note.get('title', 'N/A')}")
        else:
            print("âŒ æµ‹è¯•å¤±è´¥ï¼Œæ£€æŸ¥æ—¥å¿—")

if __name__ == "__main__":
    asyncio.run(test())
```

è¿è¡Œæµ‹è¯•ï¼š
```bash
cd backend
python test_signature.py
```

**é¢„æœŸæ—¥å¿—ï¼š**
```
ğŸŒ ä½¿ç”¨æµè§ˆå™¨æ¨¡å¼è·å–å®Œæ•´ç­¾åï¼ˆåŒ…æ‹¬ x-s-commonï¼‰
ğŸ¯ æ‹¦æˆªåˆ°ç›®æ ‡è¯·æ±‚: https://edith.xiaohongshu.com/api/sns/...
âœ… å·²æ•è·è¯·æ±‚å¤´
âœ… æµè§ˆå™¨æ¨¡å¼è·å–ç­¾åæˆåŠŸ:
   x-s: XYS_...
   x-t: 1763643364141
   x-s-common: 2UQAPsHC+...  â† å¿…é¡»æœ‰ï¼
   x-b3-traceid: xxx
âœ… æµ‹è¯•æˆåŠŸï¼
æ‰¾åˆ° 5 æ¡ç¬”è®°
```

---

## ğŸ› å¦‚æœä»ç„¶å¤±è´¥

### é—®é¢˜1ï¼šä»ç„¶è¿”å›"ç™»å½•å·²è¿‡æœŸ"

**æ’æŸ¥æ­¥éª¤ï¼š**

1. **ç¡®è®¤Cookieæ˜¯å¦è¿‡æœŸ**
   ```bash
   # é‡æ–°ä»æµè§ˆå™¨è·å–Cookie
   # 1. Chromeæ‰“å¼€ https://www.xiaohongshu.com/
   # 2. F12 â†’ Network â†’ ä»»æ„è¯·æ±‚ â†’ Copy Cookie
   # 3. æ›´æ–°åˆ°ä»£ç ä¸­
   ```

2. **ç¡®è®¤ä½¿ç”¨äº†æµè§ˆå™¨æ¨¡å¼**
   ```python
   # æ£€æŸ¥æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
   # "ğŸŒ ä½¿ç”¨æµè§ˆå™¨æ¨¡å¼è·å–å®Œæ•´ç­¾å"
   # è€Œä¸æ˜¯ï¼š
   # "âš ï¸ ä½¿ç”¨çº¯JSæ¨¡å¼"
   ```

3. **ç¡®è®¤x-s-commonå­˜åœ¨**
   ```python
   # æ—¥å¿—ä¸­åº”è¯¥çœ‹åˆ°ï¼š
   # "x-s-common: 2UQAPsHC+..."
   # å¦‚æœæ²¡æœ‰ï¼Œè¯´æ˜æµè§ˆå™¨æ¨¡å¼æœªç”Ÿæ•ˆ
   ```

### é—®é¢˜2ï¼šElectronè¿æ¥å¤±è´¥

**è§£å†³æ–¹æ³•ï¼š**

```bash
# 1. æ£€æŸ¥Electronæ˜¯å¦è¿è¡Œ
ps aux | grep electron

# 2. æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾
netstat -an | grep 9222

# 3. æµ‹è¯•è¿æ¥
curl http://localhost:9222/json/version

# 4. å¦‚æœéƒ½å¤±è´¥ï¼Œé‡å¯Electron
cd frontend
npm run electron:dev
```

### é—®é¢˜3ï¼šPlaywrightæŠ¥é”™

**å¸¸è§é”™è¯¯åŠè§£å†³ï¼š**

```bash
# é”™è¯¯1ï¼šExecutable doesn't exist
cd signature-service
npx playwright install chromium

# é”™è¯¯2ï¼šCannot connect to browser
# ç¡®ä¿æ²¡æœ‰å…¶ä»–ç¨‹åºå ç”¨9222ç«¯å£
lsof -i :9222  # macOS/Linux
netstat -ano | findstr 9222  # Windows

# é”™è¯¯3ï¼šTimeout
# å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆå·²åœ¨ä»£ç ä¸­è®¾ç½®ä¸º30ç§’ï¼‰
```

---

## ğŸ“Š æˆåŠŸæ ‡å‡†

### âœ… æ‰€æœ‰ç»¿ç¯

- [x] ç­¾åæœåŠ¡æ­£å¸¸å¯åŠ¨
- [x] Electronæ­£å¸¸è¿è¡Œï¼ˆç«¯å£9222å¯è®¿é—®ï¼‰
- [x] Pythonåç«¯æ­£å¸¸å¯åŠ¨
- [x] æµ‹è¯•è¯·æ±‚è¿”å›æ•°æ®ï¼ˆä¸æ˜¯"ç™»å½•å·²è¿‡æœŸ"ï¼‰
- [x] æ—¥å¿—ä¸­åŒ…å« `x-s-common`

### âœ… æ—¥å¿—å…³é”®å­—

æˆåŠŸçš„æ—¥å¿—åº”è¯¥åŒ…å«ï¼š
```
âœ… æµè§ˆå™¨æ¨¡å¼è·å–ç­¾åæˆåŠŸ
âœ… å·²æ•è·è¯·æ±‚å¤´
x-s-common: 2UQAPsHC+...
x-b3-traceid: ...
âœ… å“åº”æˆåŠŸ: 200
```

### âŒ å¤±è´¥æ ‡å¿—

å¦‚æœçœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼Œè¯´æ˜æœ‰é—®é¢˜ï¼š
```
âš ï¸ ä½¿ç”¨çº¯JSæ¨¡å¼ï¼Œå¯èƒ½ç¼ºå°‘ x-s-common å¯¼è‡´è¯·æ±‚å¤±è´¥
âŒ ç­¾åæœåŠ¡è¿æ¥å¤±è´¥
âŒ æµè§ˆå™¨æ¨¡å¼å‡ºé”™
ç™»å½•å·²è¿‡æœŸ  â† è¯´æ˜ç­¾åä¸å®Œæ•´
```

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒä¿®å¤

1. **XHSClient é»˜è®¤ä½¿ç”¨æµè§ˆå™¨æ¨¡å¼** - è‡ªåŠ¨è·å–å®Œæ•´ç­¾å
2. **Playwright æ•è· x-b3-traceid** - è¡¥å……ç¼ºå¤±çš„è¯·æ±‚å¤´
3. **è‡ªåŠ¨é™çº§æœºåˆ¶** - æµè§ˆå™¨å¤±è´¥æ—¶åˆ‡æ¢åˆ°çº¯JS
4. **å®Œæ•´æ–‡æ¡£å’Œæµ‹è¯•** - æ˜“äºéªŒè¯å’Œè°ƒè¯•

### å…³é”®é…ç½®

```bash
# å¿…é¡»åŒæ—¶è¿è¡Œï¼š
1. signature-service (ç«¯å£3100)
2. Electron (ç«¯å£9222)
3. backend (ç«¯å£8000)
```

### ä¸‹ä¸€æ­¥

ä¿®å¤å®Œæˆåï¼Œå»ºè®®ï¼š
1. âœ… è¿è¡Œå®Œæ•´æµ‹è¯•ç¡®è®¤åŠŸèƒ½æ­£å¸¸
2. âœ… æ›´æ–°Cookieï¼ˆå¦‚æœè¿‡æœŸï¼‰
3. â­ï¸ å®ç°xsec_tokenè‡ªåŠ¨æå–ï¼ˆç”¨äºè¯„è®ºæ¥å£ï¼‰
4. â­ï¸ å®Œå–„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

---

**ä¿®å¤å®Œæˆæ—¥æœŸï¼š** 2025-11-20  
**ç‰ˆæœ¬ï¼š** V2.0.1  
**çŠ¶æ€ï¼š** âœ… ä¸»è¦åŠŸèƒ½å·²ä¿®å¤ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨


