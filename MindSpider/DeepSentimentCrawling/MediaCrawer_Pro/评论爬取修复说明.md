# ğŸ’¬ è¯„è®ºçˆ¬å–ä¿®å¤è¯´æ˜ - xsec_token è‡ªåŠ¨è·å–

## é—®é¢˜å›é¡¾

### ç°è±¡
è¯„è®ºæ¥å£è¯·æ±‚å¤±è´¥ï¼Œç­¾åæœåŠ¡è¿”å› 500 é”™è¯¯ï¼š
```
Body: {'note_id': '...', 'xsec_token': '', 'xsec_source': 'pc_search'}  âŒ token ä¸ºç©º
âŒ æµè§ˆå™¨æ¨¡å¼ HTTP é”™è¯¯: 500
é”™è¯¯: page.evaluate: TypeError: Failed to fetch
```

### æ ¹æœ¬åŸå› 

å°çº¢ä¹¦çš„è¯„è®ºæ¥å£ `/api/sns/web/v2/comment/page` **å¼ºåˆ¶è¦æ±‚** `xsec_token`ï¼š
- å¦‚æœ `xsec_token` ä¸ºç©ºï¼Œæµè§ˆå™¨ç«¯ä¼šæ‹’ç»è¯·æ±‚
- å³ä½¿ç­¾åæœåŠ¡æˆåŠŸç”Ÿæˆ `x-s`ã€`x-s-common` ç­‰ç­¾åï¼Œè¯·æ±‚ä»ç„¶ä¼šå¤±è´¥
- å°çº¢ä¹¦è¿”å› "æš‚æ— æµè§ˆæƒé™" æˆ–ç›´æ¥ fetch å¤±è´¥

## è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒé€»è¾‘

å®ç°äº† **ä¸‰æ­¥èµ°** çš„ `xsec_token` è·å–ç­–ç•¥ï¼š

#### 1ï¸âƒ£ ä»æ•°æ®åº“ç¼“å­˜è¯»å–
```python
# å…ˆæŸ¥æ•°æ®åº“ï¼Œé¿å…é‡å¤è¯·æ±‚
note = await self.db.notes.find_one({"note_id": note_id})
xsec_token = note.get("xsec_token", "") if note else ""
```

#### 2ï¸âƒ£ è°ƒç”¨è¯¦æƒ…æ¥å£è·å–
```python
# å¦‚æœç¼“å­˜æ²¡æœ‰ï¼Œè°ƒç”¨è¯¦æƒ…æ¥å£
if not xsec_token:
    detail = await client.get_note_detail_for_token(note_id)
    xsec_token = detail.get("xsec_token", "")
    
    # ç¼“å­˜åˆ°æ•°æ®åº“
    await self.db.notes.update_one(
        {"note_id": note_id},
        {"$set": {"xsec_token": xsec_token, "xsec_source": xsec_source}}
    )
```

#### 3ï¸âƒ£ ä½¿ç”¨ token è¯·æ±‚è¯„è®º
```python
# ä¼ é€’ token ç»™è¯„è®ºæ¥å£
result = await client.get_note_comments(
    note_id=note_id,
    xsec_token=xsec_token,      # âœ… å¿…éœ€å‚æ•°
    xsec_source=xsec_source     # âœ… æ¥æºæ ‡è¯†
)
```

### è¯¦æƒ…æ¥å£

ä½¿ç”¨æ­£ç¡®çš„å°çº¢ä¹¦ç¬”è®°è¯¦æƒ…æ¥å£ï¼š
```python
POST https://edith.xiaohongshu.com/api/sns/web/v1/note/detail

Body:
{
    "note_id": "xxx",
    "image_formats": ["jpg", "webp", "avif"]
}

Response:
{
    "code": 0,
    "data": {
        "xsec_token": "xxx",      # âœ… è¿™é‡Œ
        "xsec_source": "pc_note",
        "note": {...}
    }
}
```

## ä¿®æ”¹çš„æ–‡ä»¶

### 1. `backend/services/task_service.py`

ä¿®æ”¹äº† `_crawl_comments` æ–¹æ³•ï¼š

**ä¹‹å‰**ï¼ˆé”™è¯¯ï¼‰ï¼š
```python
async def _crawl_comments(self, client, note_id, task_id):
    # âŒ ç›´æ¥è°ƒç”¨ï¼Œtoken é»˜è®¤ä¸ºç©º
    result = await client.get_note_comments(note_id)
```

**ç°åœ¨**ï¼ˆæ­£ç¡®ï¼‰ï¼š
```python
async def _crawl_comments(self, client, note_id, task_id):
    # âœ… 1. ä»æ•°æ®åº“æŸ¥æ‰¾ token
    note = await self.db.notes.find_one({"note_id": note_id})
    xsec_token = note.get("xsec_token", "") if note else ""
    
    # âœ… 2. å¦‚æœæ²¡æœ‰ï¼Œè·å–å¹¶ç¼“å­˜
    if not xsec_token:
        detail = await client.get_note_detail_for_token(note_id)
        xsec_token = detail.get("xsec_token", "")
        # ç¼“å­˜åˆ°æ•°æ®åº“
        await self.db.notes.update_one(...)
    
    # âœ… 3. ä½¿ç”¨ token è¯·æ±‚è¯„è®º
    result = await client.get_note_comments(
        note_id, xsec_token=xsec_token, xsec_source=xsec_source
    )
```

### 2. `backend/crawler/xhs_client.py`

å·²å®ç°çš„æ”¯æŒæ–¹æ³•ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰ï¼š
- âœ… `get_note_detail_for_token(note_id)` - è·å–è¯¦æƒ…é¡µå¹¶æå– token
- âœ… `get_note_comments(note_id, xsec_token, xsec_source)` - æ”¯æŒ token å‚æ•°
- âœ… `_extract_xsec_from_card()` - ä»ç¬”è®°å¡ç‰‡æå– token

## éªŒè¯æ­¥éª¤

### æ–¹æ³• 1: è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
cd backend
python test_comment_crawl.py
```

é¢„æœŸè¾“å‡ºï¼š
```
ğŸ“ æ­¥éª¤1: æœç´¢ç¬”è®°
   æ‰¾åˆ°ç¬”è®°: 68303bbb000000002100f85c
   âš ï¸ ç¬”è®°æœªåŒ…å« xsec_tokenï¼Œéœ€è¦ä»è¯¦æƒ…é¡µè·å–

ğŸ”‘ æ­¥éª¤2: è·å– xsec_token
   âœ… æˆåŠŸè·å– xsec_token: ABCDEFabcdef1234567890...
   xsec_source: pc_note

ğŸ’¬ æ­¥éª¤3: è·å–è¯„è®º
   âœ… æˆåŠŸè·å– 15 æ¡è¯„è®º
   
âœ… æµ‹è¯•å®Œæˆï¼æ‰€æœ‰æ­¥éª¤æˆåŠŸ
```

### æ–¹æ³• 2: å®é™…çˆ¬å–æµ‹è¯•

1. **å¯åŠ¨å‰ç«¯ Electron**
   ```bash
   cd frontend
   npm run dev
   ```

2. **å¯åŠ¨ç­¾åæœåŠ¡**
   ```bash
   cd signature-service
   npm run dev
   ```

3. **å¯åŠ¨åç«¯**
   ```bash
   cd backend
   python main.py
   ```

4. **åˆ›å»ºçˆ¬å–ä»»åŠ¡**
   - æ‰“å¼€å‰ç«¯ç•Œé¢
   - åˆ›å»ºä¸€ä¸ªæœç´¢ä»»åŠ¡ï¼Œå‹¾é€‰"çˆ¬å–è¯„è®º"
   - è§‚å¯Ÿåç«¯æ—¥å¿—

**é¢„æœŸæ—¥å¿—**ï¼š
```
âœ… æœç´¢åˆ° 20 æ¡ç¬”è®°: åŠ³åŠ¨
ğŸ”‘ ç¬”è®° 68303bbb000000002100f85c ç¼ºå°‘ xsec_tokenï¼Œæ­£åœ¨ä»è¯¦æƒ…é¡µè·å–...
âœ… æˆåŠŸè·å–å¹¶ç¼“å­˜ xsec_token: 68303bbb000000002100f85c
ğŸ’¬ æ­£åœ¨è·å–è¯„è®º: 68303bbb000000002100f85c (token: ABCDEFabcdef...)
âœ… æˆåŠŸçˆ¬å–è¯„è®º: 68303bbb000000002100f85c (15 æ¡)
```

## æ€§èƒ½ä¼˜åŒ–

### Token ç¼“å­˜ç­–ç•¥

1. **é¦–æ¬¡è·å–**ï¼šè°ƒç”¨è¯¦æƒ…æ¥å£ï¼Œè€—æ—¶çº¦ 1-2 ç§’
2. **åç»­ä½¿ç”¨**ï¼šç›´æ¥ä»æ•°æ®åº“è¯»å–ï¼Œè€—æ—¶ < 10ms
3. **ç¼“å­˜æœ‰æ•ˆæœŸ**ï¼šæ°¸ä¹…æœ‰æ•ˆï¼ˆé™¤éè´¦å·çŠ¶æ€å˜åŒ–ï¼‰

### æ‰¹é‡çˆ¬å–ä¼˜åŒ–

å¦‚æœéœ€è¦çˆ¬å–å¤§é‡ç¬”è®°çš„è¯„è®ºï¼Œtoken ä¼šåœ¨ç¬¬ä¸€æ¬¡è·å–åç¼“å­˜ï¼Œåç»­è¯·æ±‚é€Ÿåº¦å¤§å¹…æå‡ï¼š
- **ç¬¬ä¸€è½®**ï¼š20 ä¸ªç¬”è®° Ã— 1.5s/ä¸ª â‰ˆ 30sï¼ˆè·å– tokenï¼‰
- **ç¬¬äºŒè½®**ï¼š20 ä¸ªç¬”è®° Ã— 0.5s/ä¸ª â‰ˆ 10sï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰

## é”™è¯¯å¤„ç†

### å¦‚æœ token è·å–å¤±è´¥

ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†ä»¥ä¸‹æƒ…å†µï¼š

1. **è¯¦æƒ…æ¥å£ 404**
   ```
   âš ï¸ æ— æ³•è·å–ç¬”è®°è¯¦æƒ…: note_idï¼Œè·³è¿‡è¯„è®ºæŠ“å–
   ```

2. **è¯¦æƒ…é¡µæ—  token**
   ```
   âš ï¸ è¯¦æƒ…é¡µå“åº”ä¸­æœªæ‰¾åˆ° xsec_token: note_id
   ```

3. **è¯„è®ºæ¥å£å¤±è´¥**
   ```
   âŒ çˆ¬å–è¯„è®ºå¤±è´¥: note_id - é”™è¯¯ä¿¡æ¯
   ```

ç³»ç»Ÿä¼šè·³è¿‡å¤±è´¥çš„ç¬”è®°ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªã€‚

## æ³¨æ„äº‹é¡¹

### 1. Cookie å¿…é¡»æœ‰æ•ˆ
- `xsec_token` çš„è·å–éœ€è¦æœ‰æ•ˆçš„ç™»å½•çŠ¶æ€
- å¦‚æœ Cookie è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•

### 2. é¢‘ç‡é™åˆ¶
- ä¸è¦è¿‡å¿«è¯·æ±‚è¯¦æƒ…æ¥å£ï¼Œå»ºè®®é—´éš” 0.5-1 ç§’
- ç³»ç»Ÿå·²å†…ç½®é€Ÿç‡é™åˆ¶ï¼Œæ— éœ€æ‰‹åŠ¨æ§åˆ¶

### 3. Token çš„ä½œç”¨åŸŸ
- æ¯ä¸ªç¬”è®°çš„ token æ˜¯ç‹¬ç«‹çš„
- åŒä¸€ç¬”è®°çš„ token åœ¨å¤šæ¬¡è¯·æ±‚ä¸­å¯ä»¥å¤ç”¨
- Token ä¼šè¿‡æœŸï¼Œä½†æœ‰æ•ˆæœŸé€šå¸¸å¾ˆé•¿ï¼ˆæ•°å°æ—¶ï¼‰

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: ä»ç„¶æŠ¥ "æš‚æ— æµè§ˆæƒé™"

**å¯èƒ½åŸå› **ï¼š
- Cookie å·²è¿‡æœŸ
- è´¦å·è¢«é™åˆ¶
- IP è¢«é£æ§

**è§£å†³æ–¹æ³•**ï¼š
1. æ£€æŸ¥è´¦å·çŠ¶æ€ï¼šåœ¨å‰ç«¯"è´¦å·ç®¡ç†"ä¸­æŸ¥çœ‹
2. é‡æ–°ç™»å½•ï¼šä½¿ç”¨ Electron ç™»å½•çª—å£é‡æ–°æ‰«ç 
3. æ›´æ¢è´¦å·æˆ– IP

### é—®é¢˜ 2: è¯¦æƒ…æ¥å£è¿”å› 404

**å¯èƒ½åŸå› **ï¼š
- ç¬”è®°å·²è¢«åˆ é™¤æˆ–éšè—
- `note_id` æ ¼å¼é”™è¯¯

**è§£å†³æ–¹æ³•**ï¼š
- æ£€æŸ¥ `note_id` æ˜¯å¦æ­£ç¡®
- è·³è¿‡è¯¥ç¬”è®°ï¼Œç»§ç»­å¤„ç†å…¶ä»–ç¬”è®°

### é—®é¢˜ 3: è¯„è®ºæ•°é‡ä¸º 0

**æ­£å¸¸æƒ…å†µ**ï¼š
- æœ‰äº›ç¬”è®°ç¡®å®æ²¡æœ‰è¯„è®º
- æœ‰äº›ç¬”è®°è¯„è®ºè¢«ä½œè€…å…³é—­

**æ£€æŸ¥æ–¹æ³•**ï¼š
- åœ¨å°çº¢ä¹¦ç½‘é¡µç‰ˆæ‰‹åŠ¨æŸ¥çœ‹è¯¥ç¬”è®°
- ç¡®è®¤æ˜¯å¦çœŸçš„æœ‰è¯„è®º

## åç»­ä¼˜åŒ–å»ºè®®

1. **Token é¢„åŠ è½½**
   - åœ¨æœç´¢ç¬”è®°æ—¶ï¼Œæ‰¹é‡é¢„åŠ è½½æ‰€æœ‰ç¬”è®°çš„ token
   - å‡å°‘è¯„è®ºçˆ¬å–æ—¶çš„ç­‰å¾…æ—¶é—´

2. **Token æœ‰æ•ˆæœŸç®¡ç†**
   - è®°å½• token çš„è·å–æ—¶é—´
   - è¶…è¿‡ä¸€å®šæ—¶é—´åè‡ªåŠ¨åˆ·æ–°

3. **å¤±è´¥é‡è¯•æœºåˆ¶**
   - å¯¹äºè·å– token å¤±è´¥çš„ç¬”è®°ï¼Œç¨åè‡ªåŠ¨é‡è¯•
   - è®¾ç½®æœ€å¤§é‡è¯•æ¬¡æ•°

---

ğŸ“… ä¿®å¤æ—¶é—´: 2025-11-22  
ğŸ”– ç‰ˆæœ¬: V2.2  
ğŸ‘¤ ä¿®å¤äºº: AI Assistant


