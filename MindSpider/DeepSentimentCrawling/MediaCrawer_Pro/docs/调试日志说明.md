# 🔍 MediaCrawer Pro - 详细调试日志说明

## 📊 新增调试日志详情

为了更好地定位问题，我们在多个关键环节增加了详细的调试日志。

---

## 1️⃣ 任务执行流程日志

### 📋 任务详情（task_service.py）

```
📋 任务详情:
   任务ID: xxx
   任务类型: search
   目标数量: 100
   关键词: ['劳动仲裁']
   是否爬评论: True
   是否下载: False
```

**说明**: 显示任务的完整配置信息

---

### 🔍 账号获取（task_service.py）

```
🔍 正在获取可用账号...
✅ 使用账号: 691be52c852ff1cb3655203e
```

**说明**: 
- 如果输出 `❌ 没有可用的小红书账号`，说明没有添加账号或账号状态异常
- 需要在前端"账号管理"中添加小红书 Cookie

---

### 🌐 代理获取（task_service.py）

```
🔍 正在获取代理...
💡 不使用代理，直连
```

**说明**: 
- `✅ 使用代理: xxx:xxx` - 使用IP代理
- `💡 不使用代理，直连` - 直连（可能被风控）

---

## 2️⃣ 断点信息日志

### 💡 断点查询（checkpoint_service.py）

```
💡 未找到断点: 39eaa54c-00d5-4f5c-bc53-7bd5bc33146f
   说明: 这是任务首次执行，将从头开始爬取
```

**说明**: 
- **首次执行**: 没有断点是正常的，会从第一页开始爬
- **恢复执行**: 如果有断点，会显示：
  ```
  ✅ 找到断点: xxx
     当前关键词索引: 0
     当前页码: 3
     已爬取笔记数: 40
  ```

---

## 3️⃣ 搜索笔记日志

### 🔍 搜索请求（xhs_client.py）

```
🔍 开始搜索笔记:
   关键词: 劳动仲裁
   页码: 1
   每页数量: 20
   排序: general
📋 请求参数: {'keyword': '劳动仲裁', 'page': '1', 'page_size': '20', ...}
🌐 基础URL: https://edith.xiaohongshu.com/api/sns/web/v1/search/notes
```

**说明**: 显示搜索的完整参数

---

## 4️⃣ 签名服务日志（最关键！）

### 🔑 签名请求（signature_client.py）

```
🔑 请求签名服务:
   服务地址: http://localhost:3000/sign/xhs
   URL: https://edith.xiaohongshu.com/api/sns/web/v1/search/notes?keyword=%E5%8A%B3%E5%8A%A8%E4%BB%B2%E8%A3%81...
   Method: GET
   有a1: 是/否
   有data: 否
✅ 签名服务客户端初始化完成
📤 签名请求载荷: {'url': '...', 'method': 'GET', ...}
```

**关键错误**:
- `❌ 签名服务连接失败: [Errno 111] Connection refused`
  - **原因**: 签名服务未启动
  - **解决**: 启动签名服务 `cd sign_service && npm start`

- `❌ 签名服务HTTP错误: 500`
  - **原因**: 签名服务内部错误
  - **解决**: 检查签名服务日志

---

### ✅ 签名成功（signature_client.py）

```
✅ 签名服务响应: {'code': 0, 'data': {'x-s': 'xxx', 'x-t': 'xxx'}}
🎯 获取到签名:
   x-s: XYZ1j1fTWg91c9Mfhf4Y6K4g6yqK...
   x-t: 1700123456789
```

**说明**: 
- `x-s`: 签名字符串（动态生成）
- `x-t`: 时间戳

---

## 5️⃣ HTTP 请求日志

### 🔐 请求准备（base_client.py）

```
🔐 准备签名请求:
   URL: https://edith.xiaohongshu.com/api/sns/web/v1/search/notes?keyword=...
   Method: GET
   Params: {'keyword': '劳动仲裁', ...}
```

---

### ✅ 签名返回（base_client.py）

```
✅ 签名服务返回 headers: ['x-s', 'x-t']
📤 最终请求头: {
    'User-Agent': 'Mozilla/5.0...',
    'Referer': 'https://www.xiaohongshu.com/',
    'x-s': 'XYZ...',
    'x-t': '1700...',
    'Cookie': '***'
}
```

---

### 🔄 发送请求（base_client.py）

```
🔄 发送请求: GET https://edith.xiaohongshu.com/api/sns/web/v1/search/notes?...
✅ 响应成功: 200
📦 响应数据: {'success': True, 'data': {'items': [...]}}...
```

---

### ❌ 请求失败（base_client.py）

```
❌ HTTP 错误: 404 - https://edith.xiaohongshu.com/api/sns/web/v1/search/notes
   完整URL: https://...?keyword=%E5%8A%B3%E5%8A%A8...
   响应体: {"success": false, "msg": "接口不存在"}
```

**常见错误**:

| 状态码 | 原因 | 解决方案 |
|--------|------|----------|
| 404 | URL拼写错误 / API已废弃 | 检查URL和参数 |
| 401 | Cookie无效 / 签名错误 | 更新Cookie / 检查签名服务 |
| 403 | IP被封 / 风控 | 使用代理 / 降低频率 |
| 429 | 请求频率过高 | 增加延迟 |
| 461 | 签名错误 | 检查x-s和x-t |
| 500 | 服务器错误 | 稍后重试 |

---

## 🚀 完整调试流程示例

### ✅ 成功案例

```
2025-11-18 19:10:35 | INFO | 🚀 开始执行任务: xxx
2025-11-18 19:10:35 | INFO | 📋 任务详情:
2025-11-18 19:10:35 | INFO |    任务ID: xxx
2025-11-18 19:10:35 | INFO |    关键词: ['劳动仲裁']
2025-11-18 19:10:35 | INFO | 🔍 正在获取可用账号...
2025-11-18 19:10:35 | INFO | ✅ 使用账号: 691be52c...
2025-11-18 19:10:35 | INFO | 💡 不使用代理，直连
2025-11-18 19:10:35 | INFO | 💡 未找到断点，从头开始爬取
2025-11-18 19:10:35 | INFO | 🔍 开始搜索笔记: 劳动仲裁
2025-11-18 19:10:35 | INFO | 🔑 请求签名服务...
2025-11-18 19:10:36 | INFO | ✅ 签名服务响应: {'code': 0, ...}
2025-11-18 19:10:36 | INFO | 🔄 发送请求: GET https://...
2025-11-18 19:10:36 | INFO | ✅ 响应成功: 200
2025-11-18 19:10:36 | INFO | ✅ 搜索到 20 条笔记
```

---

### ❌ 失败案例1: 签名服务未启动

```
2025-11-18 19:10:35 | INFO | 🔑 请求签名服务...
2025-11-18 19:10:35 | ERROR | ❌ 签名服务连接失败: Connection refused
2025-11-18 19:10:35 | ERROR |    请确保签名服务正在运行: http://localhost:3000
```

**解决**: 
```bash
cd sign_service
npm start
```

---

### ❌ 失败案例2: Cookie无效

```
2025-11-18 19:10:36 | ERROR | ❌ HTTP 错误: 401
2025-11-18 19:10:36 | ERROR |    响应体: {"msg": "无登录信息，或登录信息为空"}
```

**解决**: 
1. 打开浏览器，登录小红书
2. 按F12，Network → 刷新 → 找到任意请求 → 复制Cookie
3. 前端"账号管理" → 添加账号 → 粘贴Cookie

---

### ❌ 失败案例3: 404错误

```
2025-11-18 19:10:36 | ERROR | ❌ HTTP 错误: 404
2025-11-18 19:10:36 | ERROR |    完整URL: https://edith.xiaohongshu.com/api/sns/web/v1/search/notes?...
```

**可能原因**:
1. URL拼写错误（检查代码）
2. API已更新/废弃（需要逆向最新接口）
3. 参数格式错误（检查urlencode）

---

## 🔧 调试技巧

### 1. 检查签名服务状态

```bash
curl http://localhost:3000/health
```

**预期输出**: 
```json
{"status": "ok"}
```

---

### 2. 手动测试签名

```bash
curl -X POST http://localhost:3000/sign/xhs \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://edith.xiaohongshu.com/api/sns/web/v1/search/notes?keyword=test",
    "method": "GET",
    "data": null,
    "a1": "你的a1值"
  }'
```

---

### 3. 对比浏览器请求

1. 打开 Chrome DevTools (F12)
2. 访问小红书，搜索关键词
3. Network → 找到 `search/notes` 请求
4. 对比：
   - URL参数顺序
   - 请求头（x-s, x-t）
   - Cookie字段

---

### 4. 日志级别调整

如果日志太多，可以在 `backend/core/config.py` 调整：

```python
LOG_LEVEL: str = Field(default="INFO")  # DEBUG / INFO / WARNING / ERROR
```

---

## 📝 常见问题

### Q1: 为什么日志显示 "未找到断点"？
**A**: 这是正常的！首次执行任务时没有断点，会从头开始爬取。

### Q2: 签名服务返回空数据怎么办？
**A**: 
1. 检查签名服务日志
2. 确认URL格式正确
3. 确认a1值有效

### Q3: 为什么Cookie失效了？
**A**: 
- 小红书会定期重置Cookie
- 建议每周更新一次
- 使用多个账号轮换

### Q4: 如何减少被封风险？
**A**: 
1. 使用代理池
2. 增加请求延迟（1-3秒）
3. 模拟真实用户行为
4. 避免短时间大量请求

---

## 🎯 下一步

1. **启动后端**: `cd backend && python main.py`
2. **启动签名服务**: `cd sign_service && npm start`
3. **创建任务**: 前端 → 任务管理 → 新建任务
4. **观察日志**: 根据上述说明定位问题

---

**提示**: 所有日志都会输出到控制台，建议使用 `tee` 命令保存到文件：

```bash
python main.py 2>&1 | tee backend.log
```

这样可以随时回看历史日志！








