# 小红书签名服务模式切换指南

## 📌 概述

MediaCrawer_Pro 的签名服务支持**三种模式**来生成小红书请求头，按优先级排序：

1. **🥇 第一优先级：Playwright/Browser 模式** - 使用真实浏览器捕获完整请求头
2. **🥈 第二优先级：纯JS增强模式** - JavaScript逆向 + b1参数计算x-s-common
3. **🥉 第三优先级：Python兜底** - 完全基于老仓库的Python实现

---

## 🎯 三种模式对比

| 模式 | 获取的请求头 | 优点 | 缺点 | 适用场景 |
|------|-------------|------|------|----------|
| **Playwright** | ✅ x-s<br>✅ x-t<br>✅ x-s-common<br>✅ X-B3-Traceid | 100%真实，包含所有头 | 慢（~2-3秒），需要浏览器 | 评论接口、高安全接口 |
| **JS增强** | ✅ x-s<br>✅ x-t<br>✅ x-s-common<br>✅ X-B3-Traceid | 快速（<100ms），无需浏览器 | 需要提供b1参数 | 有b1的常规请求 |
| **纯JS** | ✅ x-s<br>✅ x-t<br>❌ x-s-common<br>❌ X-B3-Traceid | 最快（<50ms），轻量 | 功能不完整 | 搜索等低安全接口 |

---

## 🚀 模式一：Playwright/Browser 模式（第一优先级）

### 特点
- 使用真实浏览器环境
- 自动捕获 `x-s-common` 和 `X-B3-Traceid`
- 可以连接到已有的 Electron 浏览器

### 使用方法

#### 方法1：HTTP API调用

```bash
POST http://localhost:3100/sign/xhs/browser

{
  "url": "https://edith.xiaohongshu.com/api/sns/web/v2/comment/page",
  "method": "GET",
  "data": null,
  "cookie": "a1=xxx; webId=yyy; ...",
  "debugPort": null
}
```

**响应示例：**
```json
{
  "success": true,
  "data": {
    "x-s": "XYS_...",
    "x-t": "1700000000000",
    "x-s-common": "2UQAPs...",
    "x-b3-traceid": "3f8a9b2c4d5e6f7g",
    "cookie": "...",
    "user-agent": "...",
    "referer": "https://www.xiaohongshu.com/",
    "origin": "https://www.xiaohongshu.com"
  },
  "mode": "browser",
  "timestamp": 1700000000000
}
```

#### 方法2：Python客户端

```python
from backend.crawler.signature_client import SignatureClient

async with SignatureClient() as client:
    # 方式A：直接调用浏览器端点（需要自己实现）
    # TODO: 添加专门的浏览器模式方法
    
    # 方式B：使用混合模式（自动选择）
    headers = await client.get_xhs_sign(
        url="/api/sns/web/v2/comment/page",
        method="GET",
        a1="your_a1_cookie",
        b1=""  # 不传b1会尝试使用浏览器模式
    )
```

### 配置 Electron 连接（可选）

如果你的应用使用 Electron，可以连接到已有浏览器实例：

```javascript
// 在 Electron 主进程中启动调试端口
const { app, BrowserWindow } = require('electron');

const mainWindow = new BrowserWindow({
  webPreferences: {
    // 启用远程调试
    webSecurity: false
  }
});

// 启动时添加参数
app.commandLine.appendSwitch('remote-debugging-port', '9222');
```

然后在调用签名服务时传入 `debugPort: 9222`。

---

## 🎨 模式二：纯JS增强模式（第二优先级）

### 特点
- 基于 xhshow 的纯JS逆向
- 传入 `b1` 参数后可生成 `x-s-common`
- 自动生成 `X-B3-Traceid`

### 使用方法

#### 方法1：HTTP API调用

```bash
POST http://localhost:3100/sign/xhs

{
  "url": "/api/sns/web/v2/comment/page?note_id=xxx",
  "method": "GET",
  "data": null,
  "a1": "your_a1_cookie",
  "b1": "your_b1_from_localStorage"  # ⚠️ 关键！
}
```

**响应示例（有b1）：**
```json
{
  "success": true,
  "data": {
    "x-s": "XYS_...",
    "x-t": "1700000000000",
    "x-s-common": "2UQAPs...",
    "x-b3-traceid": "3f8a9b2c4d5e6f7g"
  },
  "mode": "js-enhanced",
  "timestamp": 1700000000000
}
```

**响应示例（无b1）：**
```json
{
  "success": true,
  "data": {
    "x-s": "XYS_...",
    "x-t": "1700000000000"
  },
  "mode": "js",
  "timestamp": 1700000000000
}
```

#### 方法2：Python客户端

```python
from backend.crawler.signature_client import signature_client

# 获取完整签名（需要提供b1）
headers = await signature_client.get_xhs_sign(
    url="/api/sns/web/v2/comment/page",
    method="GET",
    data={"note_id": "xxx"},
    a1="your_a1_cookie",
    b1="your_b1_from_localStorage"  # ⚠️ 传入b1
)

# headers 包含：
# {
#   "x-s": "...",
#   "x-t": "...",
#   "x-s-common": "...",
#   "x-b3-traceid": "..."
# }
```

### 如何获取 b1？

`b1` 存储在浏览器的 `localStorage` 中：

**方法1：浏览器控制台**
```javascript
// 在小红书网站上打开开发者工具（F12）
console.log(localStorage.getItem('b1'));
```

**方法2：Playwright自动获取**
```python
# 在 Playwright 上下文中
b1 = await page.evaluate("() => localStorage.getItem('b1')")
```

**方法3：从 Electron 获取**
```javascript
// 在渲染进程中
const b1 = localStorage.getItem('b1');
```

---

## 🛠️ 模式三：Python兜底（第三优先级）

### 特点
- 完全基于 MediaCrawler 老仓库移植
- 作为最后的备用方案
- 命令行工具，可独立使用

### 使用方法

#### 命令行调用

```bash
cd MediaCrawer_Pro/signature-service/src/python

# 基础用法
python xhs_sign.py \
  --a1 "your_a1_cookie" \
  --b1 "your_b1_value" \
  --xs "XYS_..." \
  --xt "1700000000000"

# JSON输出
python xhs_sign.py \
  --a1 "your_a1_cookie" \
  --b1 "your_b1_value" \
  --xs "XYS_..." \
  --xt "1700000000000" \
  --json
```

#### Python模块导入

```python
import sys
sys.path.append('MediaCrawer_Pro/signature-service/src/python')

from xhs_sign import sign

# 生成完整签名
headers = sign(
    a1="your_a1_cookie",
    b1="your_b1_value",
    x_s="XYS_...",
    x_t="1700000000000"
)

# headers 包含：
# {
#   "x-s": "...",
#   "x-t": "...",
#   "x-s-common": "...",
#   "x-b3-traceid": "..."
# }
```

---

## 🔀 混合模式（Hybrid Mode）

### 特点
- 自动选择最优方案
- 优先使用JS，需要时自动切换浏览器

### 使用方法

#### HTTP API调用

```bash
POST http://localhost:3100/sign/xhs/hybrid

{
  "url": "/api/sns/web/v2/comment/page",
  "method": "GET",
  "data": null,
  "a1": "your_a1_cookie",
  "cookie": "full_cookie_string",
  "mode": "auto",  # 可选: "js", "browser", "auto"
  "debugPort": null
}
```

**mode 参数说明：**
- `"auto"` - 自动选择（默认）
- `"js"` - 强制使用JS模式
- `"browser"` - 强制使用浏览器模式

---

## 📋 实际应用场景

### 场景1：搜索笔记（低安全）

```python
# ✅ 使用纯JS模式（最快）
headers = await signature_client.get_xhs_sign(
    url="/api/sns/web/v1/search/notes",
    method="POST",
    data={"keyword": "python"},
    a1=a1_cookie
    # 不需要b1
)
```

### 场景2：获取笔记详情（中等安全）

```python
# ✅ 使用JS增强模式
headers = await signature_client.get_xhs_sign(
    url="/api/sns/web/v1/feed",
    method="POST",
    data={"source_note_id": note_id},
    a1=a1_cookie,
    b1=b1_value  # 提供b1以获取x-s-common
)
```

### 场景3：获取评论（高安全）⚠️

```python
# ✅ 必需使用完整签名（JS增强或浏览器模式）
from backend.crawler.xhs_helper import parse_note_info_from_note_url

# 1. 从笔记URL解析 xsec_token
note_info = parse_note_info_from_note_url(
    "https://www.xiaohongshu.com/explore/xxx?xsec_token=yyy&xsec_source=pc_search"
)

# 2. 获取完整签名
headers = await signature_client.get_xhs_sign(
    url=f"/api/sns/web/v2/comment/page?note_id={note_info.note_id}&xsec_token={note_info.xsec_token}",
    method="GET",
    a1=a1_cookie,
    b1=b1_value  # ⚠️ 必需
)

# 3. 发起请求
comments = await xhs_client.get_note_comments(
    note_id=note_info.note_id,
    xsec_token=note_info.xsec_token,  # ⚠️ 必需
    xsec_source=note_info.xsec_source
)
```

---

## 🔧 配置与部署

### 启动签名服务

**方式1：使用主服务器（端口3000）**
```bash
cd MediaCrawer_Pro/signature-service
npm install
npm start
```

**方式2：使用API服务器（端口3100，推荐）**
```bash
cd MediaCrawer_Pro/signature-service
node src/api/server.js
```

### 环境变量配置

```bash
# .env 文件
PORT=3100
HOST=0.0.0.0
```

### Backend配置

```python
# MediaCrawer_Pro/backend/core/config.py
class Settings(BaseSettings):
    SIGNATURE_SERVICE_URL: str = "http://localhost:3100"
    SIGNATURE_SERVICE_TIMEOUT: int = 30
```

---

## 🚨 常见问题

### Q1: 评论接口返回 461/403 错误

**原因：** 缺少 `x-s-common` 或 `X-B3-Traceid`

**解决：**
```python
# ✅ 必需传入 b1 参数
headers = await signature_client.get_xhs_sign(
    url=url,
    method="GET",
    a1=a1_cookie,
    b1=b1_value  # 不能为空！
)
```

### Q2: 如何调试签名是否正确？

**方法1：查看日志**
```python
# backend 会打印完整的请求头
logger.info(f"📤 最终请求头: {safe_headers}")
```

**方法2：对比抓包**
1. 在浏览器中打开开发者工具（F12）
2. 访问小红书并查看网络请求
3. 对比你生成的签名与真实请求

**方法3：测试端点**
```bash
# 测试签名服务是否运行
curl http://localhost:3100/health

# 测试签名生成
curl -X POST http://localhost:3100/sign/xhs \
  -H "Content-Type: application/json" \
  -d '{"url":"/api/sns/web/v1/search/notes","method":"POST","a1":"xxx","b1":"yyy"}'
```

### Q3: Playwright模式太慢怎么办？

**优化方案：**
1. **连接到已有浏览器** - 使用 `debugPort` 连接 Electron
2. **缓存浏览器实例** - 不要每次都创建新浏览器
3. **优先使用JS增强模式** - 确保传入 `b1` 参数

### Q4: b1 从哪里获取？

**最佳实践：**
```python
# 在登录后保存 b1
async def save_b1_after_login(page):
    b1 = await page.evaluate("() => localStorage.getItem('b1')")
    # 保存到数据库或配置文件
    await save_to_db("b1", b1)

# 使用时读取
b1 = await get_from_db("b1")
```

---

## 📊 性能对比

| 模式 | 平均耗时 | 成功率 | 内存占用 | CPU占用 |
|------|---------|--------|---------|---------|
| 纯JS | ~50ms | 85% | 低 | 低 |
| JS增强 | ~100ms | 95% | 低 | 低 |
| Playwright | ~2000ms | 99% | 高 | 高 |

**建议策略：**
1. 优先使用 **JS增强模式**（有b1时）
2. 高安全接口使用 **Playwright模式**
3. 批量请求时缓存签名

---

## 🎓 总结

| 场景 | 推荐模式 | 关键参数 |
|------|---------|---------|
| 搜索笔记 | 纯JS | a1 |
| 笔记详情 | JS增强 | a1 + b1 |
| 获取评论 | JS增强/Playwright | a1 + b1 + xsec_token |
| 视频链接 | JS增强 | a1 + b1 |

**核心要点：**
✅ 评论接口必须有 `xsec_token`  
✅ 高安全接口必须有 `x-s-common`  
✅ `x-s-common` 需要 `b1` 参数  
✅ 优先使用 JS增强模式（快速+完整）  

---

## 📞 技术支持

如有问题，请查看：
- 📁 `docs/API接口修复说明.md`
- 📁 `docs/Cookie配置说明.md`
- 📁 `signature-service/README.md`





