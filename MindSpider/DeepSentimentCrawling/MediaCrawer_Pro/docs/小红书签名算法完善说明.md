# 小红书签名算法完善说明

## 概述

本次更新基于 [xhshow](https://github.com/Cloxl/xhshow) 项目的签名算法，完善了 MediaCrawer_Pro 项目的小红书签名实现。

## 更新内容

### 1. 签名算法核心实现

参考 xhshow 项目的 Python 实现，将其完整移植到 Node.js，实现了以下核心功能：

#### 1.1 Base58 编码器
- 自定义 Base58 字母表
- 支持编码和解码
- 处理前导零

#### 1.2 Base64 编码器
- 自定义 Base64 字母表映射
- 标准 Base64 与自定义字母表的相互转换

#### 1.3 位运算工具
- XOR 转换数组
- 使用预定义的 HEX_KEY 进行异或操作

#### 1.4 加密处理器
- 构建完整的 payload 数组
- 时间戳编码（包含 XOR 和随机化）
- 整数转小端字节序
- 字符串转带长度前缀的字节数组

#### 1.5 主签名类（XhsSign）
- 支持 GET 和 POST 请求
- 自动提取 URI
- 构建内容字符串（支持查询参数编码）
- 生成 MD5 哈希值
- 构建完整的 x-s 签名

### 2. 配置常量

所有的配置常量都直接从 xhshow 项目移植：

```javascript
const CONFIG = {
  // 基础常量
  MAX_32BIT: 0xFFFFFFFF,
  MAX_SIGNED_32BIT: 0x7FFFFFFF,
  
  // Base58 自定义字母表
  BASE58_ALPHABET: "NOPQRStuvwxWXYZabcyz012DEFTKLMdefghijkl4563GHIJBC7mnop89+/AUVqrsOPQefghijkABCDEFGuvwz0123456789xy",
  
  // Base64 自定义字母表
  CUSTOM_BASE64_ALPHABET: "ZmserbBoHQtNP+wOcza/LpngG8yJq42KWYj0DSfdikx3VT16IlUAFM97hECvuRX5",
  
  // XOR 密钥（完整的 HEX_KEY）
  HEX_KEY: "af572b95ca65b2d9ec76bb5d2e97cb653299cc663399cc663399cce673399cce6733190c06030100...",
  
  // 版本和环境字节
  VERSION_BYTES: [119, 104, 96, 41],
  ENV_STATIC_BYTES: [1, 249, 83, 102, 103, 201, 181, 131, 99, 94, 7, 68, 250, 132, 21],
  
  // 签名数据模板
  SIGNATURE_DATA_TEMPLATE: {
    x0: "4.2.6",
    x1: "xhs-pc-web",
    x2: "Windows",
    x3: "",
    x4: "object"
  }
};
```

### 3. 签名算法流程

#### 完整的签名生成流程：

1. **提取 URI**：从完整 URL 中提取路径部分
2. **构建内容字符串**：
   - GET 请求：`URI + "?" + 参数（只编码等号为 %3D）`
   - POST 请求：`URI + JSON.stringify(data)`
3. **生成 MD5**：对内容字符串进行 MD5 哈希
4. **构建 Payload 数组**：
   - 版本字节（4字节）
   - 随机数（4字节，小端序）
   - 时间戳（8字节，经过 XOR 和随机化）
   - 启动时间戳（8字节）
   - 固定整数值（2个，各4字节）
   - 字符串参数长度（4字节）
   - MD5 前8字节（经过 XOR）
   - a1 值（带长度前缀）
   - appIdentifier（带长度前缀）
   - 环境字节（15字节）
5. **XOR 转换**：使用 HEX_KEY 对 payload 数组进行异或操作
6. **Base58 编码**：对 XOR 结果进行 Base58 编码
7. **构建最终签名**：
   - x3 = "mns0101_" + Base58编码结果
   - 签名数据 = {x0, x1, x2, x3, x4}
   - x-s = "XYS_" + Base64编码(JSON.stringify(签名数据))

### 4. API 接口更新

#### 4.1 签名服务接口（Node.js）

**请求：**
```http
POST /sign/xhs
Content-Type: application/json

{
  "url": "https://edith.xiaohongshu.com/api/sns/web/v1/search/notes",
  "method": "GET",  // 或 "POST"
  "data": {         // GET 请求为 params，POST 请求为 body
    "keyword": "美食",
    "page": 1
  },
  "a1": "your_a1_cookie_value"  // Cookie 中的 a1 值
}
```

**响应：**
```json
{
  "code": 0,
  "message": "success",
  "data": {
    "x-s": "XYS_xxxxxxxxxxxxxx",
    "x-t": "1700000000000"
  }
}
```

#### 4.2 Python 客户端更新

**SignatureClient：**
```python
async def get_xhs_sign(
    self, 
    url: str, 
    method: str = "GET",
    data: Optional[Dict] = None, 
    a1: str = ""
) -> Dict[str, str]:
    """获取小红书签名"""
```

**XHSClient：**
```python
async def sign_request(self, url: str, data: Optional[Dict] = None) -> Dict[str, str]:
    """
    调用签名服务获取 x-s 和 x-t
    自动从 cookies 中提取 a1 值
    """
    a1 = self.cookies.get("a1", "")
    method = "POST" if data else "GET"
    return await signature_client.get_xhs_sign(url, method, data, a1)
```

## 使用示例

### 1. 设置 Cookie

在使用小红书客户端前，需要先设置 Cookie（包含 a1 值）：

```python
from crawler.xhs_client import XHSClient

client = XHSClient()
await client.init_client()

# 设置完整的 cookie 字符串
client.set_cookie("a1=your_a1_value; webId=xxx; ...")

# 或者直接设置 cookies 字典
client.cookies = {
    "a1": "your_a1_value",
    "webId": "xxx",
    # ... 其他 cookies
}
```

### 2. 发起请求

设置 Cookie 后，所有请求会自动添加签名：

```python
# 搜索笔记
notes = await client.search_notes("美食", page=1)

# 获取笔记详情
note = await client.get_note_detail("note_id_xxx")

# 获取评论
comments = await client.get_note_comments("note_id_xxx")
```

### 3. 手动调用签名服务

如果需要手动调用签名服务：

```python
from crawler.signature_client import signature_client

sign_data = await signature_client.get_xhs_sign(
    url="https://edith.xiaohongshu.com/api/sns/web/v1/search/notes",
    method="GET",
    data={"keyword": "美食", "page": 1},
    a1="your_a1_value"
)

print(sign_data)
# {'x-s': 'XYS_xxxxxx', 'x-t': '1700000000000'}
```

## 技术细节

### 1. GET 请求参数编码规则

小红书对 GET 请求的参数编码有特殊要求：
- **只将 `=` 编码为 `%3D`**
- 其他字符（包括逗号）保持不编码
- 数组值使用逗号连接

示例：
```javascript
// 输入参数
{
  "keyword": "test=demo",
  "ids": ["id1", "id2"]
}

// 编码结果
"keyword=test%3Ddemo&ids=id1,id2"
```

### 2. 时间戳处理

- 使用毫秒级时间戳
- 转换为8字节小端序
- 与固定值 41 进行 XOR
- 第一个字节随机化（0-255）

### 3. 随机化机制

签名算法包含多个随机化点：
- 随机整数（4字节）：用于后续 XOR 操作
- 启动时间偏移：1000-4000ms 的随机偏移
- 时间戳首字节：0-255 的随机值
- 环境字节第二位：0-255 的随机值

这些随机化确保每次生成的签名都不同，增加安全性。

## 对比原实现

### 原实现（简化版）

```javascript
function generateXS(signString, timestamp) {
  // 使用简单的 MD5
  const hash = crypto.createHash('md5');
  hash.update(signString + timestamp);
  const md5 = hash.digest('hex');
  return `XYG_/1.0.1/WebMC${md5}`;
}
```

### 新实现（完整版）

- ✅ 完整的 Base58/Base64 编解码
- ✅ 复杂的 XOR 转换
- ✅ 时间戳编码和随机化
- ✅ Payload 数组构建
- ✅ 签名数据结构封装
- ✅ 支持 GET/POST 不同编码规则

## 注意事项

### 1. Cookie 的重要性

**a1 cookie 是必需的**，签名算法需要它来生成有效的签名。没有 a1 值，生成的签名将无法通过小红书的验证。

### 2. 版本兼容性

当前实现基于 xhshow v0.1.0，使用的签名版本为：
- x0: "4.2.6"
- x1: "xhs-pc-web"
- x2: "Windows"

如果小红书更新了签名算法或版本，可能需要更新这些配置。

### 3. 请求频率

虽然签名算法是正确的，但仍需注意：
- 合理控制请求频率
- 使用代理 IP 轮换
- 遵守平台使用规则

## 参考资料

1. **xhshow 项目**：https://github.com/Cloxl/xhshow
2. **xhshow PyPI**：https://pypi.org/project/xhshow/
3. **MediaCrawler 项目**：原始的 MediaCrawler 项目

## 更新日志

**v1.0.0** - 2024-11-16
- 基于 xhshow 项目完整实现小红书签名算法
- 支持 GET 和 POST 请求
- 完整的 Base58/Base64 编解码
- XOR 转换和随机化机制
- 更新 Python 客户端接口

## 许可声明

本实现仅供学习和研究使用，使用者应遵守：
1. 不得用于任何商业用途
2. 遵守目标平台的使用条款
3. 合理控制请求频率
4. 不得用于任何非法或不当的用途

## 贡献者

- xhshow 项目团队 - 提供了完整的签名算法实现
- MediaCrawler 项目团队 - 原始项目基础

---

**最后更新时间**：2024-11-16
























