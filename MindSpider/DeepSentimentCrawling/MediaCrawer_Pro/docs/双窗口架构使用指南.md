# 🪟 MediaCrawler Pro - 双窗口架构使用指南

## 🎯 架构设计

### 设计理念

MediaCrawler Pro 采用**双窗口架构**，完美解决了以下问题：
1. ✅ 桌面应用 UI 不被小红书页面覆盖
2. ✅ 支持扫码登录可视化
3. ✅ Playwright 能获取完整签名
4. ✅ Cookie 和 Session 持久保存

### 两个窗口

```
┌─────────────────────────────────────────┐
│        🪟 主窗口（MainWindow）          │
│   ┌───────────────────────────────┐    │
│   │     你的 Vue 桌面应用 UI      │    │
│   │  - 账号管理                    │    │
│   │  - 任务管理                    │    │
│   │  - 下载管理                    │    │
│   │  - 设置                        │    │
│   └───────────────────────────────┘    │
│                                         │
│   不受 Playwright 控制                 │
│   不会跳转到小红书                     │
│   正常显示你的应用界面                 │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│      🪟 小红书窗口（XhsWindow）         │
│   ┌───────────────────────────────┐    │
│   │     小红书官网                 │    │
│   │  - 扫码登录                    │    │
│   │  - 保持登录状态               │    │
│   │  - Playwright 控制             │    │
│   └───────────────────────────────┘    │
│                                         │
│   初始隐藏（show: false）              │
│   需要登录时显示                       │
│   登录后自动隐藏                       │
│   Playwright 可以控制此窗口           │
└─────────────────────────────────────────┘
```

---

## 🚀 快速开始

### 步骤1：启动应用

```bash
cd frontend
npm run electron:dev
```

**预期输出：**
```
╔════════════════════════════════════════════════╗
║  MediaCrawer Pro - 双窗口模式启动            ║
╚════════════════════════════════════════════════╝

🔍 远程调试已启用，端口: 9222
📖 Chrome DevTools: chrome://inspect/#devices
🎯 Playwright 连接: http://localhost:9222

🪟 创建主窗口...
✅ 主窗口创建成功

🪟 创建小红书登录窗口...
✅ 小红书窗口加载完成
✅ 小红书窗口创建成功（隐藏状态）
💡 窗口将在需要登录时显示，登录后自动隐藏

✅ 双窗口架构初始化完成

📝 窗口说明:
   🪟 主窗口: 桌面应用 UI（不受 Playwright 影响）
   🪟 小红书窗口: 登录和签名专用（Playwright 控制）

💡 使用提示:
   - 点击主窗口的"登录小红书"按钮显示登录窗口
   - 扫码登录后窗口会自动隐藏
   - Playwright 会自动连接到小红书窗口获取签名
```

### 步骤2：登录小红书

1. 在主窗口中，点击"账号管理"或"小红书登录"按钮
2. 小红书登录窗口会自动弹出
3. 使用小红书 APP 扫码登录
4. 登录成功后，窗口会自动隐藏（但继续后台运行）

### 步骤3：使用签名服务

```bash
cd signature-service
npm start
```

Playwright 会自动连接到小红书窗口（而不是主窗口）获取签名！

---

## 📝 在 Vue 中使用

### 方法1：使用 XhsLoginControl 组件（推荐）

在你的 Vue 页面中导入组件：

```vue
<template>
  <div>
    <XhsLoginControl />
  </div>
</template>

<script setup>
import XhsLoginControl from '@/components/XhsLoginControl.vue';
</script>
```

### 方法2：手动控制

如果需要自定义UI，可以直接调用 IPC：

```vue
<template>
  <div>
    <el-button @click="showLogin">显示登录窗口</el-button>
    <el-button @click="hideLogin">隐藏登录窗口</el-button>
    <el-button @click="checkLogin">检查登录状态</el-button>
  </div>
</template>

<script setup>
import { ref } from 'vue';
import { ElMessage } from 'element-plus';

const { ipcRenderer } = window.require('electron');

const showLogin = () => {
  ipcRenderer.send('show-xhs-login');
  ElMessage.success('登录窗口已打开');
};

const hideLogin = () => {
  ipcRenderer.send('hide-xhs-login');
  ElMessage.info('登录窗口已隐藏');
};

const checkLogin = async () => {
  const result = await ipcRenderer.invoke('check-xhs-login');
  
  if (result.loggedIn) {
    ElMessage.success('已登录');
    console.log('Cookie:', result.cookies);
  } else {
    ElMessage.warning('未登录');
  }
};
</script>
```

---

## 🔌 可用的 IPC 事件

### 发送事件（send）

| 事件名 | 说明 |
|--------|------|
| `show-xhs-login` | 显示小红书登录窗口 |
| `hide-xhs-login` | 隐藏小红书登录窗口 |

**示例：**
```javascript
ipcRenderer.send('show-xhs-login');
```

### 请求事件（invoke）

| 事件名 | 返回值 | 说明 |
|--------|--------|------|
| `get-xhs-cookies` | `{cookies, cookieString}` | 获取小红书 Cookie |
| `check-xhs-login` | `{loggedIn, message, cookies}` | 检查登录状态 |

**示例：**
```javascript
// 获取 Cookie
const result = await ipcRenderer.invoke('get-xhs-cookies');
console.log('Cookie 字符串:', result.cookieString);

// 检查登录
const status = await ipcRenderer.invoke('check-xhs-login');
if (status.loggedIn) {
  console.log('已登录！');
}
```

---

## 🎯 Playwright 自动连接

Playwright 现在会**自动识别并连接到小红书窗口**！

### 工作原理

```javascript
// signature-service/src/playwright/xhs_browser.js

// 1. 连接到 Electron (CDP)
const browser = await chromium.connectOverCDP('http://localhost:9222');

// 2. 遍历所有窗口
const contexts = browser.contexts();

// 3. 查找小红书窗口（通过 URL 或标题）
for (const context of contexts) {
  for (const page of context.pages()) {
    const url = page.url();
    const title = await page.title();
    
    if (url.includes('xiaohongshu.com') || 
        title.includes('小红书')) {
      // 🎯 找到了！使用这个窗口
      this.page = page;
      break;
    }
  }
}
```

### 日志输出

```
🔗 尝试连接到 Electron，调试端口: 9222
✅ CDP 连接成功
📋 找到 2 个浏览器上下文
🔍 检查上下文 (2 个页面)
   📄 页面: MediaCrawer Pro | http://localhost:5173
   📄 页面: 小红书 - 标记你的生活 | https://www.xiaohongshu.com/explore
🎯 找到小红书窗口: 小红书 - 标记你的生活
✅ 成功连接到小红书窗口
```

---

## 🔧 高级配置

### 自定义小红书窗口

修改 `frontend/electron/main.js`：

```javascript
function createXhsWindow() {
  xhsWindow = new BrowserWindow({
    width: 1000,
    height: 700,
    show: false,  // 初始是否显示
    
    // 可选：设置为主窗口的子窗口
    parent: mainWindow,
    modal: false,  // 不阻塞主窗口
    
    // 可选：窗口位置
    x: 100,
    y: 100,
    
    // 可选：窗口样式
    frame: true,  // 显示边框和标题栏
    resizable: true,  // 可调整大小
    
    webPreferences: {
      partition: 'persist:xhs',  // 独立会话，保留 Cookie
    }
  });
  
  // 可以加载不同的页面
  xhsWindow.loadURL('https://www.xiaohongshu.com/explore');
  // 或登录页：xhsWindow.loadURL('https://www.xiaohongshu.com/login');
}
```

### 自动登录检测

```javascript
xhsWindow.webContents.on('did-navigate', (event, url) => {
  console.log('📍 导航:', url);
  
  // 检测登录成功
  if (url.includes('/user/profile') || url.includes('/explore')) {
    // 获取 Cookie 检查
    xhsWindow.webContents.session.cookies.get({ domain: '.xiaohongshu.com' })
      .then(cookies => {
        const hasA1 = cookies.some(c => c.name === 'a1');
        if (hasA1) {
          console.log('✅ 检测到登录成功');
          // 自动隐藏窗口
          xhsWindow.hide();
          // 通知主窗口
          mainWindow.webContents.send('xhs-login-success', { cookies });
        }
      });
  }
});
```

---

## 🐛 故障排查

### Q1: 小红书窗口不显示

**检查：**
```javascript
// 在主进程（main.js）中添加日志
console.log('小红书窗口状态:', xhsWindow ? '已创建' : '未创建');
console.log('窗口可见性:', xhsWindow?.isVisible());
```

**解决：**
```javascript
// 确保窗口显示
if (xhsWindow) {
  xhsWindow.show();
  xhsWindow.focus();
}
```

### Q2: Playwright 连接到了错误的窗口

**检查日志：**
```
🎯 找到小红书窗口: MediaCrawer Pro | http://localhost:5173
```

如果连接到了主窗口，说明没找到小红书窗口。

**解决：**
1. 确保小红书窗口已加载完成
2. 检查窗口 URL 是否包含 `xiaohongshu.com`
3. 手动指定窗口（如果需要）

### Q3: Cookie 无法持久化

**检查会话分区：**
```javascript
// 确保使用了 persist:xhs
webPreferences: {
  partition: 'persist:xhs'
}
```

**清除 Cookie（如果需要）：**
```javascript
xhsWindow.webContents.session.clearStorageData({
  storages: ['cookies']
});
```

---

## 📊 架构优势

### 对比单窗口方案

| 特性 | 单窗口 | 双窗口 ✅ |
|------|--------|----------|
| UI 不被覆盖 | ❌ | ✅ |
| 支持扫码登录 | ❌ 需要手动粘贴Cookie | ✅ 可视化扫码 |
| Playwright 控制 | ❌ 影响主界面 | ✅ 只控制登录窗口 |
| Cookie 持久化 | ✅ | ✅ |
| 用户体验 | ⭐⭐ | ⭐⭐⭐⭐⭐ |

---

## 🎉 总结

双窗口架构的核心优势：

1. **分离关注点**
   - 主窗口：专注于应用 UI
   - 小红书窗口：专注于登录和签名

2. **用户体验优秀**
   - 扫码登录可视化
   - 登录后自动隐藏
   - 主界面不受干扰

3. **开发友好**
   - Playwright 自动找到正确的窗口
   - IPC 通信简单直观
   - 易于扩展和维护

4. **稳定可靠**
   - Cookie 持久保存
   - Session 不丢失
   - 支持长期运行

---

## 📚 相关文档

- [Electron 主进程文档](frontend/electron/main.js)
- [XhsLoginControl 组件](frontend/src/components/XhsLoginControl.vue)
- [Playwright 浏览器客户端](signature-service/src/playwright/xhs_browser.js)

---

**版本：** V2.1.0  
**更新日期：** 2025-11-21  
**作者：** MediaCrawler Team  
**状态：** ✅ 已实现并测试



