# ğŸ“Š MediaCrawer Pro - æ•°æ®åº“ç»“æ„è¯´æ˜

## ğŸ—„ï¸ æ•°æ®åº“ä¿¡æ¯

### è¿æ¥é…ç½®
```yaml
æ•°æ®åº“ç±»å‹: MongoDB (é˜¿é‡Œäº‘ RDS)
è¿æ¥URI: mongodb://root:Jchmy2025@dds-bp13820d540de8541179-pub.mongodb.rds.aliyuncs.com:3717/admin
æ•°æ®åº“å: media_crawler_pro
```

### é…ç½®æ–‡ä»¶ä½ç½®
```
backend/core/config.py
```

---

## ğŸ“‹ æ•°æ®åº“é›†åˆï¼ˆCollectionsï¼‰

### 1. `tasks` - ä»»åŠ¡è¡¨

**ç”¨é€”ï¼š** å­˜å‚¨çˆ¬å–ä»»åŠ¡ä¿¡æ¯

**å­—æ®µç»“æ„ï¼š**
```javascript
{
  "_id": ObjectId("..."),               // MongoDB è‡ªåŠ¨ç”Ÿæˆçš„ID
  "task_id": "uuid-string",              // ä»»åŠ¡å”¯ä¸€æ ‡è¯†ï¼ˆUUIDï¼‰
  "platform": "xhs",                     // å¹³å°ï¼šxhs/douyin/kuaishou/bilibili
  "type": "search",                      // ç±»å‹ï¼šsearch/homefeed
  "keywords": ["å…³é”®è¯1", "å…³é”®è¯2"],    // æœç´¢å…³é”®è¯æ•°ç»„
  "max_count": 100,                      // æœ€å¤§çˆ¬å–æ•°é‡
  "status": "pending",                   // çŠ¶æ€ï¼špending/running/completed/failed
  "created_at": ISODate("..."),          // åˆ›å»ºæ—¶é—´
  "updated_at": ISODate("..."),          // æ›´æ–°æ—¶é—´
  "started_at": ISODate("..."),          // å¼€å§‹æ—¶é—´
  "completed_at": ISODate("..."),        // å®Œæˆæ—¶é—´
  "progress": {                          // è¿›åº¦ä¿¡æ¯
    "total": 100,                        // æ€»æ•°
    "crawled": 50,                       // å·²çˆ¬å–
    "success": 48,                       // æˆåŠŸ
    "failed": 2                          // å¤±è´¥
  },
  "error": "é”™è¯¯ä¿¡æ¯"                    // é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰
}
```

**ç´¢å¼•ï¼š**
- `task_id`: å”¯ä¸€ç´¢å¼•
- `status`: æ™®é€šç´¢å¼•
- `created_at`: æ™®é€šç´¢å¼•

---

### 2. `notes` - ç¬”è®°/å¸–å­è¡¨

**ç”¨é€”ï¼š** å­˜å‚¨çˆ¬å–çš„ç¬”è®°å†…å®¹ï¼ˆå°çº¢ä¹¦ç¬”è®°ã€è§†é¢‘ç­‰ï¼‰

**å­—æ®µç»“æ„ï¼š**
```javascript
{
  "_id": ObjectId("..."),                    // MongoDB è‡ªåŠ¨ç”Ÿæˆçš„ID
  "note_id": "abc123...",                    // ç¬”è®°IDï¼ˆæ¥è‡ªå¹³å°ï¼‰
  "title": "ç¬”è®°æ ‡é¢˜",                        // æ ‡é¢˜
  "desc": "ç¬”è®°æè¿°å†…å®¹...",                  // æè¿°/æ­£æ–‡
  "type": "normal",                          // ç±»å‹ï¼šnormalï¼ˆå›¾æ–‡ï¼‰/videoï¼ˆè§†é¢‘ï¼‰
  
  // ç”¨æˆ·ä¿¡æ¯
  "user_id": "user123",                      // ç”¨æˆ·ID
  "nickname": "ç”¨æˆ·æ˜µç§°",                     // æ˜µç§°
  "avatar": "https://...",                   // å¤´åƒURL
  
  // äº’åŠ¨æ•°æ®
  "liked_count": "1234",                     // ç‚¹èµæ•°
  "collected_count": "567",                  // æ”¶è—æ•°
  "comment_count": "89",                     // è¯„è®ºæ•°
  "share_count": "12",                       // åˆ†äº«æ•°
  
  // ä½ç½®ä¿¡æ¯
  "ip_location": "ä¸Šæµ·",                      // IPå±åœ°
  
  // URL
  "note_url": "https://www.xiaohongshu.com/explore/abc123",  // ç¬”è®°é“¾æ¥
  
  // å›¾ç‰‡åˆ—è¡¨ï¼ˆå¦‚æœæ˜¯å›¾æ–‡ï¼‰
  "image_list": [
    "https://image1.jpg",
    "https://image2.jpg"
  ],
  
  // è§†é¢‘ä¿¡æ¯ï¼ˆå¦‚æœæ˜¯è§†é¢‘ï¼‰
  "video_id": "video_key_123",               // è§†é¢‘ID
  "video_url": "http://sns-video-bd.xhscdn.com/...",  // è§†é¢‘URL
  
  // æ ‡ç­¾
  "tags": ["Python", "ç¼–ç¨‹", "æ•™ç¨‹"],         // æ ‡ç­¾æ•°ç»„
  
  // æ—¶é—´æˆ³ï¼ˆè¯¦æƒ…æ¨¡å¼ï¼‰
  "time": 1700000000,                        // å‘å¸ƒæ—¶é—´æˆ³
  "last_update_time": 1700000000,            // æœ€åæ›´æ–°æ—¶é—´æˆ³
  
  // çˆ¬å–ä¿¡æ¯
  "source_keyword": "Python",                // æ¥æºå…³é”®è¯
  "task_id": "task-uuid",                    // æ‰€å±ä»»åŠ¡ID
  "crawled_at": ISODate("...")               // çˆ¬å–æ—¶é—´
}
```

**ç´¢å¼•ï¼š**
- `note_id`: å”¯ä¸€ç´¢å¼•
- `task_id`: æ™®é€šç´¢å¼•
- `source_keyword`: æ™®é€šç´¢å¼•
- `crawled_at`: æ™®é€šç´¢å¼•

---

### 3. `comments` - è¯„è®ºè¡¨

**ç”¨é€”ï¼š** å­˜å‚¨ç¬”è®°çš„è¯„è®ºæ•°æ®

**å­—æ®µç»“æ„ï¼š**
```javascript
{
  "_id": ObjectId("..."),                    // MongoDB è‡ªåŠ¨ç”Ÿæˆçš„ID
  "comment_id": "comment123",                // è¯„è®ºIDï¼ˆæ¥è‡ªå¹³å°ï¼‰
  "content": "è¯„è®ºå†…å®¹æ–‡æœ¬...",               // è¯„è®ºå†…å®¹
  
  // è¯„è®ºç”¨æˆ·ä¿¡æ¯
  "user_id": "user456",                      // è¯„è®ºè€…ç”¨æˆ·ID
  "nickname": "è¯„è®ºè€…æ˜µç§°",                   // è¯„è®ºè€…æ˜µç§°
  "avatar": "https://...",                   // è¯„è®ºè€…å¤´åƒ
  
  // ä½ç½®ä¿¡æ¯
  "ip_location": "åŒ—äº¬",                      // IPå±åœ°
  
  // äº’åŠ¨æ•°æ®
  "liked_count": "123",                      // ç‚¹èµæ•°
  "sub_comment_count": "5",                  // å­è¯„è®ºæ•°ï¼ˆå›å¤æ•°ï¼‰
  
  // æ—¶é—´
  "create_time": 1700000000,                 // åˆ›å»ºæ—¶é—´æˆ³
  
  // å…³è”ä¿¡æ¯
  "note_id": "note_abc123",                  // æ‰€å±ç¬”è®°ID
  "task_id": "task-uuid",                    // æ‰€å±ä»»åŠ¡ID
  "crawled_at": ISODate("...")               // çˆ¬å–æ—¶é—´
}
```

**ç´¢å¼•ï¼š**
- `comment_id`: å”¯ä¸€ç´¢å¼•
- `note_id`: æ™®é€šç´¢å¼•
- `task_id`: æ™®é€šç´¢å¼•
- `crawled_at`: æ™®é€šç´¢å¼•

---

### 4. `accounts` - è´¦å·è¡¨

**ç”¨é€”ï¼š** å­˜å‚¨å¹³å°è´¦å·Cookieä¿¡æ¯ï¼Œç”¨äºçˆ¬è™«ç™»å½•

**å­—æ®µç»“æ„ï¼š**
```javascript
{
  "_id": ObjectId("..."),                    // MongoDB è‡ªåŠ¨ç”Ÿæˆçš„ID
  "platform": "xhs",                         // å¹³å°ï¼šxhs/douyin/kuaishou/bilibili
  "username": "æˆ‘çš„è´¦å·",                     // ç”¨æˆ·å/å¤‡æ³¨
  
  // Cookieä¿¡æ¯
  "cookie": "å®Œæ•´cookieå­—ç¬¦ä¸²",               // Cookieå­—ç¬¦ä¸²ï¼ˆæ—§æ ¼å¼ï¼‰
  "cookies": {                               // Cookieå¯¹è±¡ï¼ˆæ–°æ ¼å¼ï¼‰
    "a1": "xxx",
    "web_session": "xxx",
    "webId": "xxx"
  },
  
  // çŠ¶æ€ä¿¡æ¯
  "status": "active",                        // çŠ¶æ€ï¼šactive/inactive/banned
  "weight": 1,                               // æƒé‡ï¼ˆç”¨äºè½®æ¢ï¼‰
  "note": "å¤‡æ³¨ä¿¡æ¯",                         // å¤‡æ³¨
  
  // ä½¿ç”¨ç»Ÿè®¡
  "use_count": 10,                           // ä½¿ç”¨æ¬¡æ•°
  "success_count": 8,                        // æˆåŠŸæ¬¡æ•°
  "fail_count": 2,                           // å¤±è´¥æ¬¡æ•°
  
  // æ—¶é—´ä¿¡æ¯
  "created_at": ISODate("..."),              // åˆ›å»ºæ—¶é—´
  "updated_at": ISODate("..."),              // æ›´æ–°æ—¶é—´
  "last_used_at": ISODate("...")             // æœ€åä½¿ç”¨æ—¶é—´
}
```

**ç´¢å¼•ï¼š**
- `platform`: æ™®é€šç´¢å¼•
- `status`: æ™®é€šç´¢å¼•

---

### 5. `proxies` - ä»£ç†è¡¨

**ç”¨é€”ï¼š** å­˜å‚¨ä»£ç†IPä¿¡æ¯

**å­—æ®µç»“æ„ï¼š**
```javascript
{
  "_id": ObjectId("..."),                    // MongoDB è‡ªåŠ¨ç”Ÿæˆçš„ID
  "ip": "123.456.789.012",                   // IPåœ°å€
  "port": 8080,                              // ç«¯å£
  "protocol": "http",                        // åè®®ï¼šhttp/https/socks5
  "username": "user",                        // ç”¨æˆ·åï¼ˆå¦‚éœ€è®¤è¯ï¼‰
  "password": "pass",                        // å¯†ç ï¼ˆå¦‚éœ€è®¤è¯ï¼‰
  
  // çŠ¶æ€ä¿¡æ¯
  "status": "active",                        // çŠ¶æ€ï¼šactive/inactive/banned
  "provider": "kuaidaili",                   // ä¾›åº”å•†
  
  // ä½¿ç”¨ç»Ÿè®¡
  "use_count": 100,                          // ä½¿ç”¨æ¬¡æ•°
  "success_count": 95,                       // æˆåŠŸæ¬¡æ•°
  "fail_count": 5,                           // å¤±è´¥æ¬¡æ•°
  
  // æ—¶é—´ä¿¡æ¯
  "created_at": ISODate("..."),              // åˆ›å»ºæ—¶é—´
  "updated_at": ISODate("..."),              // æ›´æ–°æ—¶é—´
  "last_used_at": ISODate("..."),            // æœ€åä½¿ç”¨æ—¶é—´
  "expire_at": ISODate("...")                // è¿‡æœŸæ—¶é—´
}
```

**ç´¢å¼•ï¼š**
- `ip + port`: å”¯ä¸€ç»„åˆç´¢å¼•
- `status`: æ™®é€šç´¢å¼•

---

### 6. `checkpoints` - æ–­ç‚¹è¡¨

**ç”¨é€”ï¼š** å­˜å‚¨ä»»åŠ¡æ–­ç‚¹ä¿¡æ¯ï¼Œç”¨äºæ–­ç‚¹ç»­çˆ¬

**å­—æ®µç»“æ„ï¼š**
```javascript
{
  "_id": ObjectId("..."),                    // MongoDB è‡ªåŠ¨ç”Ÿæˆçš„ID
  "task_id": "task-uuid",                    // ä»»åŠ¡ID
  
  // æ–­ç‚¹æ•°æ®
  "checkpoint_data": {
    "current_page": 5,                       // å½“å‰é¡µç 
    "current_keyword": "Python",             // å½“å‰å…³é”®è¯
    "crawled_count": 100,                    // å·²çˆ¬å–æ•°é‡
    "keyword_count": 20,                     // å½“å‰å…³é”®è¯å·²çˆ¬æ•°é‡
    "cursor": "cursor_string"                // æ¸¸æ ‡ï¼ˆç”¨äºæ¨èæµï¼‰
  },
  
  // æ—¶é—´ä¿¡æ¯
  "created_at": ISODate("..."),              // åˆ›å»ºæ—¶é—´
  "updated_at": ISODate("...")               // æ›´æ–°æ—¶é—´
}
```

**ç´¢å¼•ï¼š**
- `task_id`: å”¯ä¸€ç´¢å¼•

---

## ğŸ“ˆ æ•°æ®å…³ç³»

```
tasks (ä»»åŠ¡)
  â”œâ”€â†’ notes (ç¬”è®°)
  â”‚     â””â”€â†’ comments (è¯„è®º)
  â”œâ”€â†’ checkpoints (æ–­ç‚¹)
  â””â”€â†’ ä½¿ç”¨ accounts (è´¦å·) å’Œ proxies (ä»£ç†)
```

**å…³ç³»è¯´æ˜ï¼š**
- ä¸€ä¸ªä»»åŠ¡ï¼ˆtaskï¼‰å¯ä»¥çˆ¬å–å¤šä¸ªç¬”è®°ï¼ˆnotesï¼‰
- ä¸€ä¸ªç¬”è®°ï¼ˆnoteï¼‰å¯ä»¥æœ‰å¤šä¸ªè¯„è®ºï¼ˆcommentsï¼‰
- ä¸€ä¸ªä»»åŠ¡ï¼ˆtaskï¼‰å¯¹åº”ä¸€ä¸ªæ–­ç‚¹ï¼ˆcheckpointï¼‰
- ä»»åŠ¡æ‰§è¡Œæ—¶ä¼šä½¿ç”¨è´¦å·æ± ï¼ˆaccountsï¼‰å’Œä»£ç†æ± ï¼ˆproxiesï¼‰

---

## ğŸ” å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹

### 1. æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡
```javascript
db.tasks.find().sort({created_at: -1}).limit(10)
```

### 2. æŸ¥çœ‹æŸä¸ªä»»åŠ¡çš„æ‰€æœ‰ç¬”è®°
```javascript
db.notes.find({task_id: "task-uuid-here"})
```

### 3. æŸ¥çœ‹æŸä¸ªç¬”è®°çš„æ‰€æœ‰è¯„è®º
```javascript
db.comments.find({note_id: "note_id_here"})
```

### 4. ç»Ÿè®¡çˆ¬å–æ•°æ®é‡
```javascript
// ç¬”è®°æ€»æ•°
db.notes.countDocuments()

// è¯„è®ºæ€»æ•°
db.comments.countDocuments()

// æŒ‰å…³é”®è¯ç»Ÿè®¡ç¬”è®°æ•°
db.notes.aggregate([
  {$group: {_id: "$source_keyword", count: {$sum: 1}}},
  {$sort: {count: -1}}
])
```

### 5. æŸ¥çœ‹æœ€æ–°çˆ¬å–çš„ç¬”è®°
```javascript
db.notes.find().sort({crawled_at: -1}).limit(10)
```

### 6. æŸ¥çœ‹æ´»è·ƒè´¦å·
```javascript
db.accounts.find({status: "active"})
```

### 7. æŸ¥çœ‹è§†é¢‘ç±»ç¬”è®°
```javascript
db.notes.find({type: "video"})
```

---

## ğŸ¯ æ•°æ®å¯¼å‡ºç¤ºä¾‹

### å¯¼å‡ºæŸä¸ªä»»åŠ¡çš„æ‰€æœ‰æ•°æ®

```bash
# å¯¼å‡ºä»»åŠ¡ä¿¡æ¯
mongoexport --uri="mongodb://root:Jchmy2025@dds-bp13820d540de8541179-pub.mongodb.rds.aliyuncs.com:3717/admin" \
  --db=media_crawler_pro \
  --collection=tasks \
  --query='{"task_id":"your-task-id"}' \
  --out=tasks.json

# å¯¼å‡ºç¬”è®°
mongoexport --uri="mongodb://root:Jchmy2025@dds-bp13820d540de8541179-pub.mongodb.rds.aliyuncs.com:3717/admin" \
  --db=media_crawler_pro \
  --collection=notes \
  --query='{"task_id":"your-task-id"}' \
  --out=notes.json

# å¯¼å‡ºè¯„è®º
mongoexport --uri="mongodb://root:Jchmy2025@dds-bp13820d540de8541179-pub.mongodb.rds.aliyuncs.com:3717/admin" \
  --db=media_crawler_pro \
  --collection=comments \
  --query='{"task_id":"your-task-id"}' \
  --out=comments.json
```

---

## ğŸ› ï¸ æ•°æ®åº“ç»´æŠ¤

### åˆ›å»ºç´¢å¼•ï¼ˆå·²è‡ªåŠ¨åˆ›å»ºï¼‰

ç³»ç»Ÿä¼šåœ¨é¦–æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨åˆ›å»ºå¿…è¦çš„ç´¢å¼•ï¼Œä½†å¦‚æœéœ€è¦æ‰‹åŠ¨åˆ›å»ºï¼š

```javascript
// tasks é›†åˆ
db.tasks.createIndex({task_id: 1}, {unique: true})
db.tasks.createIndex({status: 1})
db.tasks.createIndex({created_at: -1})

// notes é›†åˆ
db.notes.createIndex({note_id: 1}, {unique: true})
db.notes.createIndex({task_id: 1})
db.notes.createIndex({source_keyword: 1})
db.notes.createIndex({crawled_at: -1})

// comments é›†åˆ
db.comments.createIndex({comment_id: 1}, {unique: true})
db.comments.createIndex({note_id: 1})
db.comments.createIndex({task_id: 1})

// accounts é›†åˆ
db.accounts.createIndex({platform: 1, status: 1})

// checkpoints é›†åˆ
db.checkpoints.createIndex({task_id: 1}, {unique: true})
```

### æ¸…ç†æ—§æ•°æ®

```javascript
// åˆ é™¤30å¤©å‰çš„ä»»åŠ¡
db.tasks.deleteMany({
  created_at: {$lt: new Date(Date.now() - 30*24*60*60*1000)}
})

// åˆ é™¤å¤±è´¥çš„ä»»åŠ¡
db.tasks.deleteMany({status: "failed"})

// åˆ é™¤æ— å…³è”ä»»åŠ¡çš„ç¬”è®°ï¼ˆå­¤å„¿æ•°æ®ï¼‰
var task_ids = db.tasks.distinct("task_id")
db.notes.deleteMany({task_id: {$nin: task_ids}})
```

---

## ğŸ“Š æ•°æ®ç»Ÿè®¡æŸ¥è¯¢

### Python æŸ¥è¯¢ç¤ºä¾‹

```python
import asyncio
from motor.motor_asyncio import AsyncIOMotorClient

async def check_stats():
    client = AsyncIOMotorClient(
        "mongodb://root:Jchmy2025@dds-bp13820d540de8541179-pub.mongodb.rds.aliyuncs.com:3717/admin"
    )
    db = client["media_crawler_pro"]
    
    # ä»»åŠ¡ç»Ÿè®¡
    total_tasks = await db.tasks.count_documents({})
    completed = await db.tasks.count_documents({"status": "completed"})
    running = await db.tasks.count_documents({"status": "running"})
    failed = await db.tasks.count_documents({"status": "failed"})
    
    # æ•°æ®ç»Ÿè®¡
    total_notes = await db.notes.count_documents({})
    total_comments = await db.comments.count_documents({})
    total_accounts = await db.accounts.count_documents({})
    
    print(f"""
ğŸ“Š æ•°æ®åº“ç»Ÿè®¡
=============
ä»»åŠ¡æ€»æ•°: {total_tasks}
  - å·²å®Œæˆ: {completed}
  - è¿è¡Œä¸­: {running}
  - å¤±è´¥: {failed}

çˆ¬å–æ•°æ®:
  - ç¬”è®°: {total_notes}
  - è¯„è®º: {total_comments}
  - è´¦å·: {total_accounts}
    """)
    
    client.close()

asyncio.run(check_stats())
```

---

## ğŸ” æ•°æ®åº“å®‰å…¨

### å½“å‰é…ç½®
- **è¿æ¥æ–¹å¼ï¼š** é˜¿é‡Œäº‘ MongoDB RDS
- **è®¤è¯ï¼š** ç”¨æˆ·å/å¯†ç è®¤è¯
- **ç½‘ç»œï¼š** å…¬ç½‘è®¿é—®ï¼ˆå·²é…ç½®ç™½åå•ï¼‰

### å®‰å…¨å»ºè®®
1. âœ… å®šæœŸæ›´æ¢æ•°æ®åº“å¯†ç 
2. âœ… é…ç½®IPç™½åå•ï¼Œé™åˆ¶è®¿é—®æ¥æº
3. âœ… å®šæœŸå¤‡ä»½æ•°æ®
4. âœ… ç›‘æ§å¼‚å¸¸æŸ¥è¯¢
5. âœ… ä¸è¦å°†æ•°æ®åº“å‡­è¯æäº¤åˆ°ä»£ç ä»“åº“

---

## ğŸ“ æ€»ç»“

| é›†åˆå | ç”¨é€” | ä¸»è¦å­—æ®µ | å…³è” |
|--------|------|---------|------|
| `tasks` | ä»»åŠ¡ä¿¡æ¯ | task_id, platform, type, status | â†’ notes, comments |
| `notes` | ç¬”è®°/è§†é¢‘ | note_id, title, video_id, video_url | â† tasks, â†’ comments |
| `comments` | è¯„è®º | comment_id, content, note_id | â† notes |
| `accounts` | è´¦å·æ±  | platform, cookies, status | è¢« tasks ä½¿ç”¨ |
| `proxies` | ä»£ç†æ±  | ip, port, status | è¢« tasks ä½¿ç”¨ |
| `checkpoints` | æ–­ç‚¹ | task_id, checkpoint_data | â† tasks |

**æ•°æ®åº“åï¼š** `media_crawler_pro`  
**æœåŠ¡å™¨ï¼š** é˜¿é‡Œäº‘ MongoDB RDS

---

**æ‰€æœ‰æ•°æ®éƒ½ä¼šä¿å­˜åˆ°è¿™ä¸ªæ•°æ®åº“ä¸­ï¼** ğŸ‰









