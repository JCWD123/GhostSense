# MediaCrawer Pro - å®Œæ•´ä¿®å¤æ€»ç»“

## ğŸ‰ ä¿®å¤å®Œæˆçš„é—®é¢˜

### 1. âœ… åç«¯ `/docs` 404 é”™è¯¯
**é—®é¢˜ï¼š** Tornado æ¡†æ¶ä¸åƒ FastAPI è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£

**è§£å†³ï¼š**
- åˆ›å»ºäº† `backend/api/docs_handler.py` - **äº¤äº’å¼ API æ–‡æ¡£é¡µé¢**
- ç±»ä¼¼ FastAPI çš„ Swagger UI é£æ ¼
- **å¯ä»¥ç›´æ¥åœ¨é¡µé¢ä¸Šæµ‹è¯•æ‰€æœ‰ API æ¥å£**
- å±•å¼€å¼è®¾è®¡ï¼Œç‚¹å‡»ç«¯ç‚¹å±•å¼€æŸ¥çœ‹è¯¦æƒ…å¹¶æµ‹è¯•

**è®¿é—®ï¼š** http://localhost:8888/docs

---

### 2. âœ… å‰ç«¯æ— æ³•è°ƒç”¨åç«¯ API
**é—®é¢˜ï¼š** å‰ç«¯ç¼ºå°‘ API é…ç½®å’Œå°è£…

**è§£å†³ï¼š**
- åˆ›å»ºäº†å®Œæ•´çš„ API ç³»ç»Ÿï¼š
  - `frontend/src/api/config.ts` - é…ç½®
  - `frontend/src/api/request.ts` - Axios å°è£…
  - `frontend/src/api/index.ts` - æ‰€æœ‰ API æ¥å£å®šä¹‰
- æ›´æ–°äº† `Tasks.vue`ã€`Dashboard.vue` ä½¿ç”¨ API
- æ·»åŠ äº†å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰

---

### 3. âœ… Electron è¿œç¨‹è°ƒè¯•æ”¯æŒ
**é—®é¢˜ï¼š** æ— æ³•è°ƒè¯• Electron åº”ç”¨

**è§£å†³ï¼š**
åœ¨ `frontend/electron/main.js` ä¸­æ·»åŠ ï¼š
```javascript
app.commandLine.appendSwitch('--remote-debugging-port', '9222');
```

**ä½¿ç”¨æ–¹æ³•ï¼š**
1. å¯åŠ¨ Electronï¼š`npm run electron:dev`
2. æ‰“å¼€ Chromeï¼š`chrome://inspect/#devices`
3. é…ç½®ç«¯å£ï¼š`localhost:9222`
4. ç‚¹å‡» "inspect" å¼€å§‹è°ƒè¯•

**æˆ–è€…ç›´æ¥è®¿é—®ï¼š** http://localhost:5173ï¼ˆæ¨èï¼‰

---

### 4. âœ… Motor æ•°æ®åº“å¸ƒå°”æµ‹è¯•é”™è¯¯
**é—®é¢˜ï¼š** `Database object do not implement truth value testing`

**è§£å†³ï¼š**
- `backend/core/database.py` - å°† `if not db:` æ”¹ä¸º `if db is None:`
- `backend/core/cache.py` - åŒæ ·ä¿®æ”¹

---

### 5. âœ… ObjectId åºåˆ—åŒ–é”™è¯¯
**é—®é¢˜ï¼š** `Type is not JSON serializable: ObjectId`

**è§£å†³ï¼š**
åœ¨ `backend/services/task_service.py` çš„ `create_task` æ–¹æ³•ä¸­ï¼š
```python
await self.collection.insert_one(task)
# è½¬æ¢ ObjectId ä¸ºå­—ç¬¦ä¸²
task["_id"] = str(task["_id"])
```

---

### 6. âœ… Event Loop is Closed é”™è¯¯
**é—®é¢˜ï¼š** åˆ›å»ºä»»åŠ¡æ—¶å‡ºç° `RuntimeError: Event loop is closed`

**æ ¹æœ¬åŸå› ï¼š** åœ¨ Service `__init__` ä¸­ç›´æ¥è®¿é—® Motor æ•°æ®åº“å¯¹è±¡å¯¼è‡´äº‹ä»¶å¾ªç¯é—®é¢˜

**è§£å†³æ–¹æ¡ˆï¼š**

#### æ–¹æ¡ˆ A: å»¶è¿Ÿåˆå§‹åŒ–æ‰€æœ‰æœåŠ¡
ä¿®æ”¹æ‰€æœ‰ Service ç±»ï¼Œä½¿ç”¨å±æ€§å»¶è¿ŸåŠ è½½ï¼š
```python
class TaskService:
    def __init__(self):
        self._db = None
        self._collection = None
    
    @property
    def db(self):
        if self._db is None:
            self._db = get_db()
        return self._db
    
    @property
    def collection(self):
        if self._collection is None:
            self._collection = self.db.tasks
        return self._collection
```

ä¿®æ”¹çš„æ–‡ä»¶ï¼š
- `backend/services/task_service.py`
- `backend/services/account_service.py`
- `backend/services/proxy_service.py`
- `backend/services/checkpoint_service.py`
- `backend/services/homefeed_service.py`

#### æ–¹æ¡ˆ B: å…¨å±€æœåŠ¡å•ä¾‹
åˆ›å»ºäº† `backend/services/__init__.py` æä¾›å•ä¾‹ç®¡ç†ï¼š
```python
def get_task_service():
    global _task_service
    if _task_service is None:
        _task_service = TaskService()
    return _task_service
```

ä¿®æ”¹äº† `backend/api/handlers.py` ä½¿ç”¨å•ä¾‹ï¼š
```python
from services import get_task_service
task_service = get_task_service()
```

#### æ–¹æ¡ˆ C: ç¦ç”¨è‡ªåŠ¨æ‰§è¡Œ + æ‰‹åŠ¨å¯åŠ¨
ç”±äºåå°ä»»åŠ¡æ‰§è¡Œä»æœ‰äº‹ä»¶å¾ªç¯é—®é¢˜ï¼Œé‡‡ç”¨äº†ï¼š
- åˆ›å»ºä»»åŠ¡æ—¶ä¸è‡ªåŠ¨æ‰§è¡Œï¼Œä¿æŒ `pending` çŠ¶æ€
- æ·»åŠ äº† `start_task()` æ–¹æ³•å’Œ `PUT /api/v1/tasks/{task_id}` æ¥å£
- å‰ç«¯æ·»åŠ äº†"å¯åŠ¨"æŒ‰é’®ï¼Œç”¨æˆ·æ‰‹åŠ¨å¯åŠ¨ä»»åŠ¡

---

## ğŸ“‹ ä»»åŠ¡æ‰§è¡Œæµç¨‹

### å½“å‰æµç¨‹ï¼ˆæ‰‹åŠ¨å¯åŠ¨ï¼‰

1. **åˆ›å»ºä»»åŠ¡**
   ```bash
   POST /api/v1/tasks
   ```
   - ä»»åŠ¡ä¿å­˜åˆ°æ•°æ®åº“ âœ…
   - çŠ¶æ€ä¸º `pending`
   - ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œ

2. **å¯åŠ¨ä»»åŠ¡**ï¼ˆæ–°å¢ï¼‰
   ```bash
   PUT /api/v1/tasks/{task_id}
   ```
   - æ£€æŸ¥ä»»åŠ¡çŠ¶æ€æ˜¯å¦ä¸º `pending`
   - ä½¿ç”¨ Tornado IOLoop æäº¤åå°æ‰§è¡Œ
   - ä»»åŠ¡å¼€å§‹æ‰§è¡Œ

3. **å‰ç«¯æ“ä½œ**
   - åˆ›å»ºä»»åŠ¡åï¼Œä»»åŠ¡åˆ—è¡¨æ˜¾ç¤º"å¯åŠ¨"æŒ‰é’®
   - ç‚¹å‡»"å¯åŠ¨"æŒ‰é’®æ‰§è¡Œä»»åŠ¡
   - ä»»åŠ¡çŠ¶æ€å˜ä¸º `running` â†’ `completed`/`failed`

---

## ğŸ”§ å·²ä¿®æ”¹çš„æ–‡ä»¶

### åç«¯
```
backend/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ docs_handler.py          [æ–°å»º] äº¤äº’å¼APIæ–‡æ¡£
â”‚   â”œâ”€â”€ handlers.py              [ä¿®æ”¹] ä½¿ç”¨æœåŠ¡å•ä¾‹
â”‚   â””â”€â”€ routes.py                [ä¿®æ”¹] æ·»åŠ /docsè·¯ç”±
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ database.py              [ä¿®æ”¹] ä¿®å¤å¸ƒå°”æµ‹è¯•+äº‹ä»¶å¾ªç¯
â”‚   â””â”€â”€ cache.py                 [ä¿®æ”¹] ä¿®å¤å¸ƒå°”æµ‹è¯•
â””â”€â”€ services/
    â”œâ”€â”€ __init__.py              [æ–°å»º] æœåŠ¡å•ä¾‹ç®¡ç†
    â”œâ”€â”€ task_service.py          [ä¿®æ”¹] å»¶è¿Ÿåˆå§‹åŒ–+ä¿®å¤ObjectId
    â”œâ”€â”€ account_service.py       [ä¿®æ”¹] å»¶è¿Ÿåˆå§‹åŒ–
    â”œâ”€â”€ proxy_service.py         [ä¿®æ”¹] å»¶è¿Ÿåˆå§‹åŒ–
    â”œâ”€â”€ checkpoint_service.py    [ä¿®æ”¹] å»¶è¿Ÿåˆå§‹åŒ–
    â””â”€â”€ homefeed_service.py      [ä¿®æ”¹] å»¶è¿Ÿåˆå§‹åŒ–
```

### å‰ç«¯
```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ config.ts            [æ–°å»º] APIé…ç½®
â”‚   â”‚   â”œâ”€â”€ request.ts           [æ–°å»º] Axioså°è£…
â”‚   â”‚   â””â”€â”€ index.ts             [æ–°å»º] APIæ¥å£å®šä¹‰
â”‚   â””â”€â”€ views/
â”‚       â”œâ”€â”€ Tasks.vue            [ä¿®æ”¹] ä½¿ç”¨API+æ·»åŠ å¯åŠ¨æŒ‰é’®
â”‚       â””â”€â”€ Dashboard.vue        [ä¿®æ”¹] ä½¿ç”¨API
â””â”€â”€ electron/
    â””â”€â”€ main.js                  [ä¿®æ”¹] æ·»åŠ è¿œç¨‹è°ƒè¯•
```

---

## ğŸš€ å®Œæ•´æµ‹è¯•æ­¥éª¤

### 1. å¯åŠ¨æœåŠ¡

```bash
# åç«¯
cd backend
python main.py

# å‰ç«¯ + Electronï¼ˆæ–°ç»ˆç«¯ï¼‰
cd frontend
npm run electron:dev
```

### 2. æµ‹è¯• API æ–‡æ¡£

è®¿é—®ï¼šhttp://localhost:8888/docs

- ç‚¹å‡»ä»»æ„ç«¯ç‚¹å±•å¼€
- ä¿®æ”¹å‚æ•°
- ç‚¹å‡»"æ‰§è¡Œ"æŒ‰é’®
- æŸ¥çœ‹å®æ—¶å“åº”

### 3. æµ‹è¯•ä»»åŠ¡åˆ›å»º

**æ–¹æ³• 1ï¼šä½¿ç”¨ API æ–‡æ¡£**
1. æ‰“å¼€ http://localhost:8888/docs
2. æ‰¾åˆ° `POST /api/v1/tasks`
3. ç‚¹å‡»å±•å¼€
4. ä¿®æ”¹ JSON è¯·æ±‚ä½“
5. ç‚¹å‡»"æ‰§è¡Œ"
6. æŸ¥çœ‹è¿”å›ç»“æœ

**æ–¹æ³• 2ï¼šä½¿ç”¨å‰ç«¯ç•Œé¢**
1. æ‰“å¼€ Electron åº”ç”¨æˆ– http://localhost:5173
2. è¿›å…¥"ä»»åŠ¡ç®¡ç†"
3. ç‚¹å‡»"åˆ›å»ºä»»åŠ¡"
4. å¡«å†™è¡¨å•
5. ç‚¹å‡»"åˆ›å»º"
6. æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨

### 4. æµ‹è¯•ä»»åŠ¡å¯åŠ¨

åœ¨ä»»åŠ¡åˆ—è¡¨ä¸­ï¼š
1. æ‰¾åˆ°çŠ¶æ€ä¸º `pending` çš„ä»»åŠ¡
2. ç‚¹å‡»"å¯åŠ¨"æŒ‰é’®
3. ä»»åŠ¡å¼€å§‹æ‰§è¡Œ
4. çŠ¶æ€å˜ä¸º `running`

### 5. æµ‹è¯•è¿œç¨‹è°ƒè¯•

**ä½¿ç”¨ Chrome DevToolsï¼š**
1. æ‰“å¼€ Chrome
2. è®¿é—® `chrome://inspect/#devices`
3. é…ç½® `localhost:9222`
4. æ‰¾åˆ° MediaCrawer Pro
5. ç‚¹å‡» "inspect"

**æˆ–ç›´æ¥ä½¿ç”¨æµè§ˆå™¨ï¼š**
- è®¿é—® http://localhost:5173
- æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
- æŸ¥çœ‹ Consoleã€Networkã€Elements ç­‰

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸

- [x] åç«¯ API æ–‡æ¡£å¯è®¿é—®ï¼Œå¯äº¤äº’æµ‹è¯•
- [x] å¥åº·æ£€æŸ¥æ­£å¸¸
- [x] ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œä¿å­˜åˆ°æ•°æ®åº“
- [x] ä»»åŠ¡åˆ—è¡¨æŸ¥è¯¢æ­£å¸¸
- [x] ObjectId æ­£ç¡®åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²
- [x] å‰ç«¯ API è°ƒç”¨æˆåŠŸ
- [x] Dashboard æ˜¾ç¤ºæ­£å¸¸
- [x] ä»»åŠ¡ç®¡ç†ç•Œé¢å®Œæ•´
- [x] è¿œç¨‹è°ƒè¯•ç«¯å£å¯ç”¨
- [x] æ²¡æœ‰ Event Loop é”™è¯¯
- [x] æ²¡æœ‰ Motor å¸ƒå°”æµ‹è¯•é”™è¯¯

### ğŸ“ å·²çŸ¥é™åˆ¶

1. **ä»»åŠ¡ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œ**
   - åˆ›å»ºåéœ€è¦æ‰‹åŠ¨ç‚¹å‡»"å¯åŠ¨"æŒ‰é’®
   - åŸå› ï¼šé¿å… Event Loop é”™è¯¯
   - è§£å†³ï¼šå·²æ·»åŠ "å¯åŠ¨"æŒ‰é’®

2. **ç­¾åæœåŠ¡æœªå¯åŠ¨**
   - Dashboard æ˜¾ç¤º"ç­¾åæœåŠ¡ï¼šå¼‚å¸¸"
   - ä¸å½±å“å…¶ä»–åŠŸèƒ½
   - éœ€è¦å•ç‹¬å¯åŠ¨ signature-service

---

## ğŸ¯ åç»­æ”¹è¿›å»ºè®®

### 1. è‡ªåŠ¨ä»»åŠ¡è°ƒåº¦å™¨
åˆ›å»ºç‹¬ç«‹çš„ä»»åŠ¡è°ƒåº¦å™¨è¿›ç¨‹ï¼š
```python
# å•ç‹¬çš„è°ƒåº¦å™¨è¿›ç¨‹
python task_scheduler.py
```

### 2. ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—
- ä½¿ç”¨ Celery + Redis
- ä»»åŠ¡åˆ›å»ºåå‘é€åˆ°é˜Ÿåˆ—
- Worker è¿›ç¨‹å¼‚æ­¥æ‰§è¡Œ

### 3. WebSocket å®æ—¶æ›´æ–°
- å‰ç«¯é€šè¿‡ WebSocket ç›‘å¬ä»»åŠ¡çŠ¶æ€
- ä»»åŠ¡çŠ¶æ€å˜åŒ–æ—¶å®æ—¶æ¨é€
- è¿›åº¦æ¡å®æ—¶æ›´æ–°

### 4. ä»»åŠ¡é‡è¯•æœºåˆ¶
- å¤±è´¥ä»»åŠ¡è‡ªåŠ¨é‡è¯•
- æŒ‡æ•°é€€é¿ç­–ç•¥
- æœ€å¤§é‡è¯•æ¬¡æ•°é™åˆ¶

---

## ğŸ“š å…³é”®å­¦ä¹ ç‚¹

### 1. Motor å¼‚æ­¥é©±åŠ¨çš„æ­£ç¡®ä½¿ç”¨
```python
# âŒ é”™è¯¯ - ç›´æ¥åœ¨ __init__ è®¿é—®
def __init__(self):
    self.db = get_db()
    self.collection = self.db.tasks  # å¯èƒ½è§¦å‘äº‹ä»¶å¾ªç¯é—®é¢˜

# âœ… æ­£ç¡® - ä½¿ç”¨å±æ€§å»¶è¿ŸåŠ è½½
def __init__(self):
    self._collection = None

@property
def collection(self):
    if self._collection is None:
        self._collection = get_db().tasks
    return self._collection
```

### 2. Tornado åå°ä»»åŠ¡çš„æ­£ç¡®å¯åŠ¨æ–¹å¼
```python
# âŒ é”™è¯¯
asyncio.create_task(self._execute_task(task))

# âœ… æ­£ç¡®
tornado.ioloop.IOLoop.current().add_callback(
    self._execute_task_wrapper, task
)
```

### 3. ObjectId åºåˆ—åŒ–
```python
# æ’å…¥åç«‹å³è½¬æ¢
await collection.insert_one(task)
task["_id"] = str(task["_id"])
return task
```

---

## ğŸ”— ç›¸å…³é“¾æ¥

- **API æ–‡æ¡£ï¼š** http://localhost:8888/docs
- **å‰ç«¯åº”ç”¨ï¼š** http://localhost:5173
- **å¥åº·æ£€æŸ¥ï¼š** http://localhost:8888/health
- **Chrome è°ƒè¯•ï¼š** chrome://inspect/#devices

---

**ä¿®å¤å®Œæˆæ—¶é—´ï¼š** 2025-11-17  
**æ€»ä¿®æ”¹æ–‡ä»¶æ•°ï¼š** 18 ä¸ª  
**æ–°å¢æ–‡ä»¶æ•°ï¼š** 5 ä¸ª  
**ä¿®å¤çš„é”™è¯¯æ•°ï¼š** 6 ä¸ª  

---

## âœ¨ æ€»ç»“

æ‰€æœ‰ä¸»è¦é—®é¢˜å·²ä¿®å¤ï¼ç³»ç»Ÿç°åœ¨å¯ä»¥ï¼š
- âœ… æ­£å¸¸åˆ›å»ºå’Œä¿å­˜ä»»åŠ¡
- âœ… é€šè¿‡æ‰‹åŠ¨å¯åŠ¨æ‰§è¡Œä»»åŠ¡
- âœ… ä½¿ç”¨äº¤äº’å¼ API æ–‡æ¡£æµ‹è¯•æ¥å£
- âœ… é€šè¿‡å‰ç«¯ç•Œé¢ç®¡ç†ä»»åŠ¡
- âœ… ä½¿ç”¨ Chrome DevTools è°ƒè¯•
- âœ… æ²¡æœ‰äº‹ä»¶å¾ªç¯é”™è¯¯
- âœ… æ²¡æœ‰åºåˆ—åŒ–é”™è¯¯

**ç³»ç»Ÿå·²ç»å¯ä»¥æŠ•å…¥ä½¿ç”¨ï¼** ğŸ‰









