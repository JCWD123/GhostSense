# ğŸ”§ æµè§ˆå™¨æ¨¡å¼500é”™è¯¯å®Œæ•´ä¿®å¤æŒ‡å—

## ğŸ“‹ é—®é¢˜æè¿°

æŠ¥é”™ä¿¡æ¯ï¼š
```
âŒ æµè§ˆå™¨æ¨¡å¼å‡ºé”™: Server error '500 Internal Server Error' 
for url 'http://localhost:3100/sign/xhs/browser'
```

è¿™è¡¨ç¤ºç­¾åæœåŠ¡çš„æµè§ˆå™¨æ¨¡å¼ç«¯ç‚¹å‡ºé”™äº†ã€‚

---

## ğŸ¯ å·²å®Œæˆçš„ä¿®å¤

### 1. æ”¹è¿›äº†CDPè¿æ¥å®ç°

**ä¿®æ”¹æ–‡ä»¶ï¼š** `signature-service/src/playwright/xhs_browser.js`

**æ”¹è¿›å†…å®¹ï¼š**
- âœ… å¢åŠ äº†è¯¦ç»†çš„CDPè¿æ¥æ—¥å¿—
- âœ… æ”¹è¿›äº†é”™è¯¯å¤„ç†å’Œè¯Šæ–­ä¿¡æ¯
- âœ… ä¼˜åŒ–äº†é¡µé¢åŠ è½½ç­–ç•¥ï¼ˆ`domcontentloaded` ä»£æ›¿ `networkidle`ï¼‰
- âœ… æ·»åŠ äº†è¿æ¥å¤±è´¥çš„è¯¦ç»†æç¤º

### 2. å¢å¼ºäº†APIæœåŠ¡å™¨é”™è¯¯å¤„ç†

**ä¿®æ”¹æ–‡ä»¶ï¼š** `signature-service/src/api/server.js`

**æ”¹è¿›å†…å®¹ï¼š**
- âœ… è¯¦ç»†çš„è¯·æ±‚æ—¥å¿—
- âœ… åˆ†ç±»çš„é”™è¯¯ä¿¡æ¯
- âœ… é’ˆå¯¹æ€§çš„è§£å†³å»ºè®®
- âœ… å®Œæ•´çš„é”™è¯¯å †æ ˆè¾“å‡º

### 3. åˆ›å»ºäº†è¯Šæ–­æµ‹è¯•è„šæœ¬

**æ–°å¢æ–‡ä»¶ï¼š** `signature-service/test_browser_mode.js`

**åŠŸèƒ½ï¼š**
- âœ… æ£€æŸ¥Electronè°ƒè¯•ç«¯å£
- âœ… æµ‹è¯•CDPåè®®è¿æ¥
- âœ… æµ‹è¯•ç‹¬ç«‹æµè§ˆå™¨å¯åŠ¨
- âœ… å®Œæ•´çš„æµè§ˆå™¨æ¨¡å¼æµ‹è¯•

---

## ğŸ” è¯Šæ–­æ­¥éª¤

### æ­¥éª¤1ï¼šè¿è¡Œè¯Šæ–­è„šæœ¬

```bash
cd signature-service
node test_browser_mode.js
```

**é¢„æœŸè¾“å‡ºï¼š**
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  Playwrightæµè§ˆå™¨æ¨¡å¼è¯Šæ–­å·¥å…·        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ Electronè°ƒè¯•ç«¯å£æ­£å¸¸ (ç«¯å£ 9222)
  æµè§ˆå™¨: Chrome/120.0.6099.109
  åè®®ç‰ˆæœ¬: 1.3

âœ“ CDPè¿æ¥æˆåŠŸ
  æ‰¾åˆ° 1 ä¸ªæµè§ˆå™¨ä¸Šä¸‹æ–‡
  æ‰¾åˆ° 1 ä¸ªé¡µé¢

âœ“ æµè§ˆå™¨å¯åŠ¨æˆåŠŸ
âœ“ é¡µé¢åŠ è½½æˆåŠŸ

âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ (4/4)
```

### æ­¥éª¤2ï¼šæ£€æŸ¥å…·ä½“é—®é¢˜

æ ¹æ®è¯Šæ–­ç»“æœï¼Œå®šä½é—®é¢˜ï¼š

#### é—®é¢˜Aï¼šElectronè°ƒè¯•ç«¯å£ä¸å¯ç”¨

**ç—‡çŠ¶ï¼š**
```
âœ— Electronè°ƒè¯•ç«¯å£ä¸å¯ç”¨ (ç«¯å£ 9222)
```

**åŸå› ï¼š**
1. Electronåº”ç”¨æœªè¿è¡Œ
2. è°ƒè¯•ç«¯å£æœªå¼€å¯
3. ç«¯å£è¢«å…¶ä»–ç¨‹åºå ç”¨

**è§£å†³æ–¹æ³•ï¼š**

```bash
# 1. ç¡®è®¤Electroné…ç½®æ­£ç¡®
# æ£€æŸ¥ frontend/electron/main.js æ˜¯å¦æœ‰ï¼š
app.commandLine.appendSwitch('--remote-debugging-port', '9222');
app.commandLine.appendSwitch('--remote-allow-origins', '*');

# 2. å¯åŠ¨Electron
cd frontend
npm run electron:dev

# 3. éªŒè¯ç«¯å£
curl http://localhost:9222/json/version

# 4. å¦‚æœç«¯å£è¢«å ç”¨ï¼Œæ‰¾å‡ºå ç”¨ç¨‹åº
# Linux/Mac:
lsof -i :9222
# Windows:
netstat -ano | findstr 9222
```

#### é—®é¢˜Bï¼šCDPè¿æ¥å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
âœ— CDPè¿æ¥å¤±è´¥: connect ECONNREFUSED
```

**åŸå› ï¼š**
1. Playwrightç‰ˆæœ¬ä¸Electronä¸å…¼å®¹
2. CDPç«¯ç‚¹é…ç½®é”™è¯¯
3. ç½‘ç»œé˜²ç«å¢™é˜»æ­¢

**è§£å†³æ–¹æ³•ï¼š**

```bash
# 1. æ£€æŸ¥Playwrightç‰ˆæœ¬
npm list playwright

# 2. å¦‚æœç‰ˆæœ¬è¾ƒæ—§ï¼Œæ›´æ–°
npm install playwright@latest

# 3. é‡æ–°å®‰è£…Chromium
npx playwright install chromium

# 4. æµ‹è¯•CDPç«¯ç‚¹
curl http://localhost:9222/json/list
# åº”è¯¥è¿”å›æµè§ˆå™¨é¡µé¢åˆ—è¡¨
```

#### é—®é¢˜Cï¼šç‹¬ç«‹æµè§ˆå™¨å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶ï¼š**
```
âœ— æµè§ˆå™¨å¯åŠ¨å¤±è´¥: Executable doesn't exist
```

**åŸå› ï¼š**
Playwrightçš„Chromiumæœªå®‰è£…

**è§£å†³æ–¹æ³•ï¼š**

```bash
cd signature-service
npx playwright install chromium

# å¦‚æœç½‘ç»œé—®é¢˜ï¼Œè®¾ç½®ä»£ç†
export PLAYWRIGHT_DOWNLOAD_HOST=https://npmmirror.com/mirrors/playwright
npx playwright install chromium
```

---

## ğŸ› ï¸ å®Œæ•´ä¿®å¤æµç¨‹

### æµç¨‹Aï¼šä½¿ç”¨Electronæµè§ˆå™¨ï¼ˆæ¨èï¼‰

```bash
# 1. å¯åŠ¨Electronï¼ˆå¿…é¡»ï¼ï¼‰
cd frontend
npm run electron:dev

# ç­‰å¾…çœ‹åˆ°ï¼š
# ğŸ” è¿œç¨‹è°ƒè¯•å·²å¯ç”¨ï¼Œç«¯å£: 9222

# 2. éªŒè¯è°ƒè¯•ç«¯å£
curl http://localhost:9222/json/version
# åº”è¯¥è¿”å›JSONæ•°æ®

# 3. å¯åŠ¨ç­¾åæœåŠ¡
cd ../signature-service
npm start

# 4. æµ‹è¯•æµè§ˆå™¨æ¨¡å¼
node test_browser_mode.js

# 5. å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œå¯åŠ¨Pythonåç«¯
cd ../backend
python main.py
```

### æµç¨‹Bï¼šä½¿ç”¨ç‹¬ç«‹Playwrightæµè§ˆå™¨ï¼ˆå¤‡é€‰ï¼‰

```bash
# 1. å®‰è£…Playwrightæµè§ˆå™¨
cd signature-service
npx playwright install chromium

# 2. ä¿®æ”¹Pythonåç«¯ï¼Œä¸æŒ‡å®šdebugPort
# åœ¨ backend/crawler/xhs_client.py ä¸­ï¼š
# è°ƒç”¨æ—¶ä¸ä¼  debugPort=9222

# 3. å¯åŠ¨æœåŠ¡
npm start

# 4. æµ‹è¯•ï¼ˆä¸éœ€è¦Electronï¼‰
node test_browser_mode.js
```

---

## ğŸ“Š è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

**ç­¾åæœåŠ¡æ—¥å¿—ï¼š**
```bash
cd signature-service
npm start

# æ—¥å¿—ä¼šæ˜¾ç¤ºï¼š
# ğŸŒ æµè§ˆå™¨æ¨¡å¼è¯·æ±‚: https://...
# ğŸ“¡ CDP URL: http://localhost:9222
# âœ… CDP è¿æ¥æˆåŠŸ
# ğŸ“‹ æ‰¾åˆ° 1 ä¸ªæµè§ˆå™¨ä¸Šä¸‹æ–‡
# âœ… æˆåŠŸè¿æ¥åˆ° Electron æµè§ˆå™¨
```

**Pythonåç«¯æ—¥å¿—ï¼š**
```bash
cd backend
python main.py

# æ—¥å¿—ä¼šæ˜¾ç¤ºï¼š
# ğŸŒ ä½¿ç”¨æµè§ˆå™¨æ¨¡å¼è·å–å®Œæ•´ç­¾å
# âœ… æµè§ˆå™¨æ¨¡å¼è·å–ç­¾åæˆåŠŸ:
#    x-s: ...
#    x-s-common: ...  â† å¿…é¡»æœ‰ï¼
```

### æ‰‹åŠ¨æµ‹è¯•APIç«¯ç‚¹

```bash
# æµ‹è¯•æµè§ˆå™¨æ¨¡å¼ç«¯ç‚¹
curl -X POST http://localhost:3100/sign/xhs/browser \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://edith.xiaohongshu.com/api/sns/web/v1/search/notes",
    "method": "POST",
    "data": {"keyword": "test"},
    "cookie": "a1=xxx; webId=xxx",
    "debugPort": 9222
  }'

# æˆåŠŸè¿”å›ï¼š
# {
#   "success": true,
#   "data": {
#     "x-s": "...",
#     "x-t": "...",
#     "x-s-common": "...",  â† å…³é”®ï¼
#     "x-b3-traceid": "..."
#   },
#   "mode": "browser"
# }

# å¤±è´¥è¿”å›ï¼š
# {
#   "success": false,
#   "message": "...",
#   "error": "...",
#   "suggestions": [...]
# }
```

---

## ğŸ¯ å¸¸è§é”™è¯¯åŠè§£å†³

### é”™è¯¯1ï¼š`connect ECONNREFUSED 127.0.0.1:9222`

**åŸå› ï¼š** Electronæœªè¿è¡Œæˆ–ç«¯å£æœªå¼€å¯

**è§£å†³ï¼š**
```bash
cd frontend
npm run electron:dev
```

### é”™è¯¯2ï¼š`Protocol error (Browser.getVersion): Browser closed`

**åŸå› ï¼š** Electronåœ¨è¿æ¥åå…³é—­äº†

**è§£å†³ï¼š**
1. ç¡®ä¿Electronä¿æŒè¿è¡Œ
2. ä¸è¦åœ¨æµ‹è¯•æ—¶å…³é—­Electronçª—å£

### é”™è¯¯3ï¼š`Timeout 30000ms exceeded`

**åŸå› ï¼š** é¡µé¢åŠ è½½è¶…æ—¶

**è§£å†³ï¼š**
1. æ£€æŸ¥ç½‘ç»œè¿æ¥
2. æ£€æŸ¥å°çº¢ä¹¦ç½‘ç«™æ˜¯å¦å¯è®¿é—®
3. å·²ä¿®å¤ï¼šæ”¹ä¸ºä½¿ç”¨ `domcontentloaded`

### é”™è¯¯4ï¼š`Target page, context or browser has been closed`

**åŸå› ï¼š** é¡µé¢æˆ–æµè§ˆå™¨è¢«æ„å¤–å…³é—­

**è§£å†³ï¼š**
```javascript
// åœ¨ xhs_browser.js ä¸­å¢åŠ é‡è¿æœºåˆ¶ï¼ˆå·²å®ç°ï¼‰
try {
  await this.page.goto(...);
} catch (error) {
  if (error.message.includes('closed')) {
    // é‡æ–°åˆå§‹åŒ–
    await this.init(cookie);
  }
}
```

---

## ğŸ“ æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰è¯·ç¡®è®¤ï¼š

- [ ] Electronåº”ç”¨æ­£åœ¨è¿è¡Œ
- [ ] è°ƒè¯•ç«¯å£9222å¯è®¿é—®ï¼ˆ`curl http://localhost:9222/json/version`ï¼‰
- [ ] Playwrightå·²å®‰è£…ï¼ˆ`npm list playwright`ï¼‰
- [ ] Chromiumæµè§ˆå™¨å·²å®‰è£…ï¼ˆ`npx playwright install chromium`ï¼‰
- [ ] ç­¾åæœåŠ¡æ­£å¸¸å¯åŠ¨ï¼ˆ`npm start`ï¼‰
- [ ] è¯Šæ–­è„šæœ¬æµ‹è¯•é€šè¿‡ï¼ˆ`node test_browser_mode.js`ï¼‰
- [ ] Cookieæ˜¯æœ‰æ•ˆçš„ï¼ˆæœªè¿‡æœŸï¼‰

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å¤ç”¨æµè§ˆå™¨å®ä¾‹

å½“å‰å®ç°å·²ç»æ”¯æŒå¤ç”¨Electronæµè§ˆå™¨ï¼Œæ— éœ€æ¯æ¬¡è¯·æ±‚éƒ½å¯åŠ¨æ–°æµè§ˆå™¨ã€‚

### 2. ä½¿ç”¨æµè§ˆå™¨æ± 

å¦‚æœæœ‰é«˜å¹¶å‘éœ€æ±‚ï¼Œå¯ä»¥è€ƒè™‘ï¼š

```javascript
// åˆ›å»ºæµè§ˆå™¨æ± 
class BrowserPool {
  constructor(size = 3) {
    this.browsers = [];
    this.size = size;
  }
  
  async init() {
    for (let i = 0; i < this.size; i++) {
      const browser = await chromium.launch({...});
      this.browsers.push(browser);
    }
  }
  
  async getBrowser() {
    // è½®è¯¢è¿”å›å¯ç”¨æµè§ˆå™¨
  }
}
```

### 3. é™çº§ç­–ç•¥

```python
# Pythonç«¯å®ç°è‡ªåŠ¨é™çº§
try:
    # ä¼˜å…ˆä½¿ç”¨Electronæµè§ˆå™¨
    headers = await get_headers(debugPort=9222)
except:
    # é™çº§åˆ°ç‹¬ç«‹æµè§ˆå™¨
    headers = await get_headers(debugPort=None)
except:
    # é™çº§åˆ°çº¯JSç­¾å
    headers = await get_js_sign()
```

---

## ğŸ‰ ä¿®å¤åéªŒè¯

ä¿®å¤å®Œæˆåï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```bash
# 1. è¯Šæ–­æµ‹è¯•å…¨éƒ¨é€šè¿‡
$ node test_browser_mode.js
âœ“ æ‰€æœ‰æµ‹è¯•é€šè¿‡ (4/4)

# 2. APIæµ‹è¯•æˆåŠŸ
$ curl -X POST http://localhost:3100/sign/xhs/browser ...
{"success":true,"data":{...}}

# 3. Pythonåç«¯æ—¥å¿—æ­£å¸¸
âœ… æµè§ˆå™¨æ¨¡å¼è·å–ç­¾åæˆåŠŸ:
   x-s-common: 2UQAPsHC+...  â† æœ‰å€¼ï¼

# 4. å°çº¢ä¹¦APIè¿”å›æ•°æ®ï¼ˆä¸æ˜¯"ç™»å½•å·²è¿‡æœŸ"ï¼‰
{'success': True, 'data': {'items': [...]}}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [CDPåè®®æ–‡æ¡£](https://chromedevtools.github.io/devtools-protocol/)
- [Playwrightæ–‡æ¡£](https://playwright.dev/docs/api/class-browsertype#browser-type-connect-over-cdp)
- [Electronè¿œç¨‹è°ƒè¯•](https://www.electronjs.org/docs/latest/tutorial/debugging-main-process)

---

**ä¿®å¤æ—¥æœŸï¼š** 2025-11-21  
**ä¿®å¤ç‰ˆæœ¬ï¼š** V2.0.2  
**çŠ¶æ€ï¼š** âœ… å·²ä¿®å¤å¹¶å¢å¼ºé”™è¯¯å¤„ç†



